<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vern Browser Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/x-icon" href="logo.png" /> <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet" />

    <style id="custom-styles">
        /* Base Elements */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #fff;
            --navbar-bg: rgba(15, 15, 15, 1);
            --navbar-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            --button-bg: rgba(10, 10, 10, 0.8);
            --button-hover-bg: rgba(15, 15, 15, 0.9);
            --input-bg: rgba(10, 10, 10, 0.8); /* Renamed from --search-bg for broader use */
            --input-focus-bg: rgba(45, 45, 45, 0.9);
            --input-focus-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
            --iframe-bg: #202020;
            --footer-text-color: #fff;
            --font-family-main: 'Roboto Mono', monospace;
            --tab-bg: rgba(25, 25, 25, 0.8);
            --tab-active-bg: rgba(45, 45, 45, 0.9);
            --tab-border: rgba(60, 60, 60, 0.5);
            --tab-hover-bg: rgba(35, 35, 35, 0.9);
            --sidebar-width: 280px;
            --sidebar-bg: rgba(10, 10, 10, 0.95);
            --sidebar-item-hover-bg: rgba(30, 30, 30, 0.9);
            --sidebar-border-color: rgba(255, 255, 255, 0.1);
            --button-text-color: #fff;
        }

        /* Light Theme */
        body.theme-light {
            --bg-color: #f4f4f4;
            --text-color: #333;
            --navbar-bg: #ffffff;
            --navbar-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            --button-bg: #e0e0e0;
            --button-hover-bg: #d0d0d0;
            --input-bg: #ffffff;
            --input-focus-bg: #f0f0f0;
            --input-focus-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
            --iframe-bg: #ffffff;
            --footer-text-color: #555;
            --tab-bg: #e9e9e9;
            --tab-active-bg: #ffffff;
            --tab-border: #cccccc;
            --tab-hover-bg: #f5f5f5;
            --sidebar-bg: #f8f9fa;
            --sidebar-item-hover-bg: #e9ecef;
            --sidebar-border-color: #dee2e6;
            --button-text-color: #333; /* Text color for buttons in light mode */
        }

        /* Blue Theme */
        body.theme-blue {
            --bg-color: #0d1b2a; /* Dark Blue */
            --text-color: #e0e1dd; /* Light Gray/Blue */
            --navbar-bg: #1b263b; /* Darker Blue */
            --navbar-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            --button-bg: #415a77; /* Muted Blue */
            --button-hover-bg: #778da9; /* Lighter Muted Blue */
            --input-bg: #1b263b;
            --input-focus-bg: #415a77;
            --input-focus-shadow: 0 0 0 3px rgba(120, 150, 255, 0.4);
            --iframe-bg: #0d1b2a;
            --footer-text-color: #e0e1dd;
            --tab-bg: #2a3b4e;
            --tab-active-bg: #415a77;
            --tab-border: #566f8e;
            --tab-hover-bg: #3a4f66;
            --sidebar-bg: #101B27;
            --sidebar-item-hover-bg: #1b263b;
            --sidebar-border-color: rgba(255, 255, 255, 0.15);
            --button-text-color: #e0e1dd;
        }


        html, body {
            margin: 0;
            padding: 0;
            border: none;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: var(--font-family-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex; /* For sidebar layout */
        }

        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border-color);
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
            transition: margin-left 0.35s ease-in-out, width 0.35s ease-in-out;
            z-index: 1001; /* Above canvas, below modals if any */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #sidebar.hidden {
            margin-left: calc(-1 * var(--sidebar-width));
            /* width: 0; Could also animate width, but margin-left is often smoother for content shift */
        }

        #sidebar h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 1px solid var(--sidebar-border-color);
            padding-bottom: 8px;
        }

        #sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 200px; /* Example height, adjust as needed */
            overflow-y: auto;
        }
         #sidebar ul::-webkit-scrollbar { width: 5px; }
         #sidebar ul::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); border-radius: 3px; }


        #sidebar li {
            padding: 8px 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background-color 0.2s ease;
        }
        #sidebar li:hover {
            background-color: var(--sidebar-item-hover-bg);
        }
        #sidebar li .bookmark-url, #sidebar li .history-url {
            font-size: 0.8em;
            opacity: 0.7;
            display: block;
        }
        #sidebar .sidebar-input, #sidebar .sidebar-select {
            width: calc(100% - 20px);
            padding: 8px 10px;
            margin-bottom: 10px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--sidebar-border-color);
            border-radius: 4px;
            font-family: var(--font-family-main);
        }
        #sidebar .sidebar-button {
            padding: 8px 15px;
            background-color: var(--button-bg);
            color: var(--button-text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-family: var(--font-family-main);
        }
        #sidebar .sidebar-button:hover {
            background-color: var(--button-hover-bg);
        }


        /* Main Content Area */
        #main-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* Important */
            transition: margin-left 0.35s ease-in-out; /* For when sidebar is truly removed with width */
        }

        #top-bar-assembly {
            overflow: hidden;
            transition: max-height 0.35s ease-in-out;
        }
        #top-bar-assembly.hidden {
            max-height: 0 !important;
        }

        /* Tab Bar */
        #tab-bar {
            display: flex;
            background-color: var(--navbar-bg);
            padding: 10px 12px;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: thin;
            position: relative;
            align-items: center;
            gap: 8px;
        }
        #tab-bar::-webkit-scrollbar { height: 3px; }
        #tab-bar::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.3); border-radius: 3px; }

        .tab {
            display: flex; align-items: center; min-width: 160px; max-width: 200px; height: 32px;
            padding: 0 12px; background-color: var(--tab-bg); border-radius: 16px; cursor: pointer;
            transition: all 0.2s ease; overflow: hidden; position: relative; box-shadow: 0 0 0 1px var(--tab-border);
        }
        .tab.active { background-color: var(--tab-active-bg); box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3); }
        .tab:hover:not(.active) { background-color: var(--tab-hover-bg); }
        .tab-favicon { width: 16px; height: 16px; margin-right: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .tab-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; }
        .tab-close { width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-left: 4px; flex-shrink: 0; opacity: 0.7; transition: opacity 0.2s, background-color 0.2s; }
        .tab-close:hover { opacity: 1; background-color: rgba(255, 255, 255, 0.2); }

        .new-tab-button {
            width: 32px; height: 32px; min-width: 32px; margin-left: 6px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; background-color: var(--button-bg);
            cursor: pointer; transition: background-color 0.2s; box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
        }
        .new-tab-button:hover { background-color: var(--button-hover-bg); }

        /* Navigation Bar */
        #nav-bar {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: var(--navbar-bg);
            box-shadow: var(--navbar-shadow);
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
        }

        .nav-button {
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            margin-right: 10px; border-radius: 50%; background-color: var(--button-bg);
            cursor: pointer; color: var(--button-text-color); transition: background-color 0.2s, color 0.2s;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        }
        .nav-button:hover { background-color: var(--button-hover-bg); }

        #search-bar {
            flex: 1; height: 40px; border-radius: 30px; border: none; background-color: var(--input-bg);
            color: var(--text-color); padding: 0 18px; font-size: 15px; font-weight: 700;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5); font-family: var(--font-family-main);
        }
        #search-bar:focus { outline: none; background-color: var(--input-focus-bg); box-shadow: var(--input-focus-shadow); font-weight: 700; }

        /* Toggle Buttons */
        #toggle-top-bar-button, #toggle-sidebar-button {
            position: fixed;
            z-index: 1002; /* Above sidebar if sidebar uses margin, same level if sidebar uses transform */
            width: 40px;
            height: 32px;
            background-color: var(--navbar-bg);
            border-radius: 0 0 100px 100px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            transition: top 0.35s ease-in-out, left 0.35s ease-in-out, background-color 0.2s ease-in-out, transform 0.35s ease-in-out;
            box-shadow: -2px 0 0 0 rgba(255, 255, 255, 0.5), 2px 0 0 0 rgba(255, 255, 255, 0.5), 0 2px 0 0 rgba(255, 255, 255, 0.5);
        }
        #toggle-top-bar-button:hover, #toggle-sidebar-button:hover {
            background-color: var(--button-hover-bg);
        }
        #toggle-top-bar-button .fas, #toggle-sidebar-button .fas {
            font-size: 14px;
            transition: transform 0.3s ease-in-out;
        }

        #toggle-top-bar-button {
            right: 2px;
            /* top position is set by JS */
        }
        #toggle-sidebar-button {
            left: 0px; /* Initial position, will be updated by JS */
            top: 2px; /* Position it near the top left */
            border-radius: 0 100px 100px 0; /* Rounded on the right */
             box-shadow: /* Adjust shadow for left-side button */
               0 -2px 0 0 rgba(255, 255, 255, 0.5), /* top */
               2px 0 0 0 rgba(255, 255, 255, 0.5), /* right */
               0 2px 0 0 rgba(255, 255, 255, 0.5); /* bottom */
        }


        /* Content Area */
        #tabs-container {
            flex: 1; position: relative; background-color: var(--iframe-bg);
        }
        .tab-content {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            border: none;
        }
        .tab-content.active {
            display: block;
        }

        .footer-label {
            position: fixed; bottom: 0; right: 0; margin: 1rem; font-family: var(--font-family-main);
            font-size: 0.9rem; color: var(--footer-text-color); text-decoration: none; z-index: 1000;
        }

    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div id="sidebar">
        <div id="sidebar-header">
            <h2 style="text-align: center; margin-bottom: 20px;">Vern Pro</h2>
        </div>

        <div id="bookmarks-section">
            <h3><i class="fas fa-bookmark"></i> Bookmarks</h3>
            <input type="text" id="new-bookmark-name" class="sidebar-input" placeholder="Name (optional)">
            <button id="add-current-bookmark-button" class="sidebar-button" style="width:100%; margin-bottom:10px;">Bookmark Current Page</button>
            <ul id="bookmarks-list"></ul>
        </div>

        <div id="history-section">
            <h3><i class="fas fa-history"></i> Session History</h3>
            <ul id="history-list"></ul>
        </div>

        <div id="settings-section">
            <h3><i class="fas fa-cog"></i> Settings</h3>
            <label for="theme-selector" style="display:block; margin-bottom:5px;">Theme:</label>
            <select id="theme-selector" class="sidebar-select">
                <option value="default">Default Dark</option>
                <option value="light">Light Mode</option>
                <option value="blue">Ocean Blue</option>
            </select>
        </div>
    </div>

    <div id="toggle-sidebar-button" title="Toggle Sidebar">
        <i id="toggle-sidebar-icon" class="fas fa-chevron-left"></i>
    </div>

    <div id="main-content-wrapper">
        <div id="top-bar-assembly">
            <div id="tab-bar">
                <div class="new-tab-button" id="new-tab-button" title="New Tab">
                    <i class="fas fa-plus"></i>
                </div>
            </div>
            <div id="nav-bar">
                <div class="nav-button" id="home-button" title="Home"> <i class="fas fa-home"></i> </div>
                <div class="nav-button" id="back-button" title="Back"> <i class="fas fa-arrow-left"></i> </div>
                <div class="nav-button" id="forward-button" title="Forward"> <i class="fas fa-arrow-right"></i> </div>
                <div class="nav-button" id="refresh-button" title="Refresh"> <i class="fas fa-redo"></i> </div>
                <input type="text" id="search-bar" placeholder="Search or type a URL">
            </div>
        </div>

        <div id="toggle-top-bar-button" title="Hide Toolbar">
            <i id="toggle-bar-icon" class="fas fa-chevron-up"></i>
        </div>

        <div id="tabs-container">
            </div>
    </div>

    <a href="https://github.com/4simpleproblems/vern" target="_blank" class="footer-label">Vern Proxy by 4SP</a> <script src="uv/uv.bundle.js" defer></script>
    <script src="uv/uv.config.js" defer></script>
    <script src="register-sw.js" defer></script>
    <script src="stars.js" defer></script>

    <script>
        // --- CONFIGURATION & GLOBAL STATE ---
        let tabs = [];
        let activeTabId = null;
        let tabCounter = 0;
        let sessionHistory = []; // For session history
        const MAX_HISTORY_ITEMS = 50; // Max items in session history

        // --- DOM ELEMENT REFERENCES ---
        let tabBarEl, tabsContainerEl, searchBarEl, newTabButtonEl, homeButtonEl, backButtonEl, forwardButtonEl, refreshButtonEl;
        let topBarAssemblyEl, toggleTopBarButtonEl, toggleBarIconEl;
        let sidebarEl, toggleSidebarButtonEl, toggleSidebarIconEl, mainContentWrapperEl;
        let bookmarksListEl, addCurrentBookmarkButtonEl, newBookmarkNameInputEl;
        let historyListEl;
        let themeSelectorEl;

        let initialTopBarHeight = 0;
        let isTopBarHidden = false;
        let isSidebarHidden = false; //localStorage.getItem('vernSidebarHidden') === 'true'; // Optional: Persist sidebar state

        // --- PROXY & SEARCH CONFIG (Assumed from uv.config.js and search.js) ---
        // Ensure __uv$config is available globally from uv.config.js
        // Ensure searchFast is available (either from a search.js or define it here)
        function searchFast(query, searchEngineUrl = 'https://duckduckgo.com/?q=%s') {
            try {
                new URL(query); // Check if it's a valid URL
                return query.startsWith('http://') || query.startsWith('https://') ? query : 'https://' + query;
            } catch (err) {
                return searchEngineUrl.replace('%s', encodeURIComponent(query));
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize DOM elements
            tabBarEl = document.getElementById('tab-bar');
            tabsContainerEl = document.getElementById('tabs-container');
            searchBarEl = document.getElementById('search-bar');
            newTabButtonEl = document.getElementById('new-tab-button');
            homeButtonEl = document.getElementById('home-button');
            backButtonEl = document.getElementById('back-button');
            forwardButtonEl = document.getElementById('forward-button');
            refreshButtonEl = document.getElementById('refresh-button');

            topBarAssemblyEl = document.getElementById('top-bar-assembly');
            toggleTopBarButtonEl = document.getElementById('toggle-top-bar-button');
            toggleBarIconEl = document.getElementById('toggle-bar-icon');

            sidebarEl = document.getElementById('sidebar');
            toggleSidebarButtonEl = document.getElementById('toggle-sidebar-button');
            toggleSidebarIconEl = document.getElementById('toggle-sidebar-icon');
            mainContentWrapperEl = document.getElementById('main-content-wrapper');

            bookmarksListEl = document.getElementById('bookmarks-list');
            addCurrentBookmarkButtonEl = document.getElementById('add-current-bookmark-button');
            newBookmarkNameInputEl = document.getElementById('new-bookmark-name');
            historyListEl = document.getElementById('history-list');
            themeSelectorEl = document.getElementById('theme-selector');

            // Initialize UV service worker
            await initUV();

            // Initial UI setup
            updateInitialTopBarHeight();
            if (!isTopBarHidden) topBarAssemblyEl.style.maxHeight = initialTopBarHeight + 'px';
            else {
                topBarAssemblyEl.style.maxHeight = '0px';
                topBarAssemblyEl.classList.add('hidden');
                handleTopBarToggle(true); // Set icon and title correctly
            }

            // Sidebar initial state
            if (isSidebarHidden) {
                sidebarEl.classList.add('hidden');
                // mainContentWrapperEl.style.marginLeft = '0'; // If sidebar has width 0
                toggleSidebarIconEl.className = 'fas fa-chevron-right';
                toggleSidebarButtonEl.style.left = '0px';
                toggleSidebarButtonEl.title = "Show Sidebar";
            } else {
                // mainContentWrapperEl.style.marginLeft = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
                 toggleSidebarButtonEl.style.left = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
                toggleSidebarIconEl.className = 'fas fa-chevron-left';
                toggleSidebarButtonEl.title = "Hide Sidebar";
            }


            // Event Listeners
            setupEventListeners();

            // Load persisted data
            loadBookmarks();
            loadSavedTheme(); // Also applies the theme

            // Create initial tab
            const urlParams = new URLSearchParams(window.location.search);
            const initialUrl = urlParams.get('url');
            if (tabs.length === 0) {
                createTab(initialUrl || 'about:blank');
            }

            // Initial render of history (empty at start)
            renderHistory();
        });

        async function initUV() {
            try {
                if (typeof registerSW !== 'function') {
                    console.warn("registerSW() function not found. UV Service Worker might not be registered. Ensure register-sw.js is loaded.");
                    return;
                }
                await registerSW();
                console.log("Service worker registered successfully for Vern Pro.");
            } catch (err) {
                console.error("Failed to register UV service worker:", err);
                alert("Error: Could not initialize proxy service. Some websites may not load correctly.");
            }
        }

        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            if(toggleTopBarButtonEl) toggleTopBarButtonEl.addEventListener('click', () => handleTopBarToggle());
            if(toggleSidebarButtonEl) toggleSidebarButtonEl.addEventListener('click', handleSidebarToggle);

            window.addEventListener('resize', () => {
                if (!isTopBarHidden) updateInitialTopBarHeight();
                if (!isSidebarHidden) { // Adjust sidebar toggle button position on resize
                     toggleSidebarButtonEl.style.left = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
                }
            });

            if(newTabButtonEl) newTabButtonEl.addEventListener('click', () => createTab('about:blank'));
            if(tabBarEl) tabBarEl.addEventListener('click', handleTabBarClick);
            if(searchBarEl) searchBarEl.addEventListener('keydown', handleSearchEnter);

            // Nav buttons
            if(homeButtonEl) homeButtonEl.addEventListener('click', () => navigateTo('about:blank')); // Or your desired home URL
            if(backButtonEl) backButtonEl.addEventListener('click', () => getActiveTab()?.iframe.contentWindow.history.back());
            if(forwardButtonEl) forwardButtonEl.addEventListener('click', () => getActiveTab()?.iframe.contentWindow.history.forward());
            if(refreshButtonEl) refreshButtonEl.addEventListener('click', () => {
                const activeTab = getActiveTab();
                if (activeTab && activeTab.iframe.contentWindow) {
                    try {
                        // If it's a UV proxied page, refreshing the iframe source is better
                        if (activeTab.iframe.src.includes(__uv$config.prefix)) {
                             activeTab.iframe.src = activeTab.iframe.src; // Re-assign to force reload
                        } else {
                             activeTab.iframe.contentWindow.location.reload();
                        }
                    } catch (e) {
                        console.warn("Error trying to reload, attempting src reassignment:", e);
                        activeTab.iframe.src = activeTab.iframe.src; // Fallback
                    }
                }
            });


            // Sidebar features
            if(addCurrentBookmarkButtonEl) addCurrentBookmarkButtonEl.addEventListener('click', handleAddCurrentBookmark);
            if(bookmarksListEl) bookmarksListEl.addEventListener('click', handleBookmarkClick);
            if(historyListEl) historyListEl.addEventListener('click', handleHistoryClick);
            if(themeSelectorEl) themeSelectorEl.addEventListener('change', handleThemeChange);

            // Global keyboard shortcuts
            document.addEventListener('keydown', handleGlobalKeyDown);

            // Iframe load and message listeners
            // Using event delegation for iframe load events
            document.addEventListener('load', handleIframeLoad, true); // Capture phase
            window.addEventListener('message', handleWindowMessage);
        }


        // --- TAB MANAGEMENT ---
        function createTab(url = null) {
            const tabId = `tab-${tabCounter++}`;
            const contentId = `content-${tabId}`;

            const tabElement = document.createElement('div');
            tabElement.className = 'tab';
            tabElement.dataset.tabId = tabId;
            tabElement.innerHTML = `<div class="tab-favicon"><i class="fas fa-globe" style="font-size: 14px;"></i></div><div class="tab-title">New Tab</div><div class="tab-close"><i class="fas fa-times"></i></div>`;
            tabBarEl.insertBefore(tabElement, newTabButtonEl);

            const iframe = document.createElement('iframe');
            iframe.id = contentId;
            iframe.className = 'tab-content';
            iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-popups allow-presentation allow-downloads'; // Common sandbox attributes
            iframe.loading = 'eager'; // Load active tabs eagerly
            // For advanced speed: Consider 'allow-top-navigation-by-user-activation' if needed and understood.
            // CSP can be set here too: iframe.setAttribute('csp', "frame-src *; object-src 'none'; script-src 'unsafe-inline' 'unsafe-eval' *;"); // EXAMPLE ONLY, TIGHTEN THIS!
            tabsContainerEl.appendChild(iframe);

            const tab = {
                id: tabId,
                contentId: contentId,
                element: tabElement,
                iframe: iframe,
                url: url || 'about:blank', // Store the intended, unproxied URL
                title: 'New Tab',
                titleElement: tabElement.querySelector('.tab-title'),
                faviconElement: tabElement.querySelector('.tab-favicon'),
                history: [], // Simple back/forward history for this tab (optional if relying on iframe's history)
                isLoading: false
            };
            tabs.push(tab);
            activateTab(tabId);
            navigateTo(tab.url, tab); // This will handle if it's about:blank or needs proxying

            return tab;
        }

        function activateTab(tabId) {
            if (!tabId && tabs.length > 0) tabId = tabs[0].id; // Fallback
            if (!tabId) return;

            tabs.forEach(t => {
                t.element.classList.remove('active');
                t.iframe.classList.remove('active');
            });
            const tab = tabs.find(t => t.id === tabId);
            if (tab) {
                tab.element.classList.add('active');
                tab.iframe.classList.add('active');
                activeTabId = tabId;
                searchBarEl.value = (tab.url && tab.url !== 'about:blank') ? tab.url : '';
                tab.element.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
                updateDocumentTitle(tab);
            }
        }

        function closeTab(tabId) {
            const tabIndex = tabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;
            const tab = tabs[tabIndex];

            // Cleanup (if any specific cleanup for this tab is needed, e.g., observers)
            if (tab.titleObserver) tab.titleObserver.disconnect();
            if (tab.locationCheckIntervalId) clearInterval(tab.locationCheckIntervalId);


            tab.element.remove();
            tab.iframe.remove();
            tabs.splice(tabIndex, 1);

            if (activeTabId === tabId) {
                if (tabs.length > 0) {
                    activateTab(tabs[Math.max(0, tabIndex - 1)].id);
                } else {
                    createTab('about:blank'); // Create a new blank tab if all are closed
                }
            }
        }

        function getActiveTab() {
            return tabs.find(t => t.id === activeTabId);
        }

        function updateTabInfo(tab, title, faviconUrl) {
            if (!tab) return;

            const displayTitle = title || (tab.url === 'about:blank' ? 'New Tab' : (tab.url || 'Loading...'));
            tab.title = displayTitle;
            tab.titleElement.textContent = displayTitle;
            tab.titleElement.title = displayTitle; // For tooltip

            if (faviconUrl) {
                tab.faviconElement.innerHTML = `<img src="${faviconUrl}" alt="" style="width:16px;height:16px;object-fit:contain;">`;
            } else if (tab.url && tab.url !== 'about:blank' && tab.url.startsWith('http')) {
                // Basic favicon guess (can be improved with a fetcher)
                try {
                    const siteUrl = new URL(tab.url);
                    tab.faviconElement.innerHTML = `<img src="${siteUrl.protocol}//${siteUrl.hostname}/favicon.ico" alt="" style="width:16px;height:16px;object-fit:contain;" onerror="this.parentNode.innerHTML = '<i class=\\'fas fa-globe\\' style=\\'font-size: 14px;\\'></i>';">`;
                } catch (e) {
                    tab.faviconElement.innerHTML = `<i class="fas fa-globe" style="font-size: 14px;"></i>`;
                }
            } else {
                tab.faviconElement.innerHTML = `<i class="fas fa-globe" style="font-size: 14px;"></i>`;
            }

            if (tab.id === activeTabId) {
                updateDocumentTitle(tab);
            }
        }

        function updateDocumentTitle(tab) {
            if (!tab) tab = getActiveTab();
            if (tab) {
                document.title = `${tab.title || 'New Tab'} - Vern Browser Pro`;
            } else {
                document.title = 'Vern Browser Pro';
            }
        }

        // --- NAVIGATION ---
        function navigateTo(urlInput, tab = null) {
            let currentTab = tab || getActiveTab();
            if (!currentTab) {
                console.warn("NavigateTo called without an active tab, creating one.");
                currentTab = createTab(urlInput); // Create new tab if none active
                return; // createTab will call navigateTo again
            }

            currentTab.isLoading = true;
            updateTabInfo(currentTab, "Loading...", null);


            if (!urlInput || typeof urlInput !== 'string' || urlInput.trim() === '') {
                urlInput = 'about:blank';
            }

            if (urlInput === 'about:blank' || urlInput.startsWith('about:')) {
                currentTab.iframe.src = urlInput;
                currentTab.url = urlInput;
                if (currentTab.id === activeTabId) searchBarEl.value = '';
                updateTabInfo(currentTab, urlInput === 'about:blank' ? 'New Tab' : urlInput);
                addToHistory(urlInput === 'about:blank' ? 'New Tab' : urlInput, urlInput);
                currentTab.isLoading = false;
                return;
            }

            const formattedUrl = searchFast(urlInput); // Uses your searchFast logic

            if (typeof __uv$config === 'undefined' || typeof __uv$config.prefix === 'undefined' || typeof __uv$config.encodeUrl !== 'function') {
                console.error("UV configuration (__uv$config) is not available. Ensure uv.config.js is loaded.");
                currentTab.iframe.src = `about:blank#error=uv_config_missing&url=${encodeURIComponent(formattedUrl)}`;
                updateTabInfo(currentTab, "Error: UV Config Missing");
                currentTab.isLoading = false;
                return;
            }

            try {
                const proxiedUrl = self.location.origin + __uv$config.prefix + __uv$config.encodeUrl(formattedUrl);
                currentTab.iframe.src = proxiedUrl;
                currentTab.url = formattedUrl; // Store the original, unproxied URL
                if (currentTab.id === activeTabId) searchBarEl.value = formattedUrl;
                // Title will be updated by iframe load event or MutationObserver
            } catch (err) {
                console.error("Navigation error:", err);
                currentTab.iframe.src = `about:blank#error=${encodeURIComponent(err.message)}&query=${encodeURIComponent(urlInput)}`;
                updateTabInfo(currentTab, "Navigation Error");
                currentTab.isLoading = false;
            }
        }


        // --- UI TOGGLES & RESIZE ---
        function handleTopBarToggle(forceState) { // forceState true = hidden, false = shown
            if (forceState !== undefined) isTopBarHidden = forceState;
            else isTopBarHidden = !isTopBarHidden;

            if (isTopBarHidden) {
                topBarAssemblyEl.classList.add('hidden');
                toggleTopBarButtonEl.style.top = '-1px';
                toggleBarIconEl.className = 'fas fa-chevron-down';
                toggleTopBarButtonEl.title = "Show Toolbar";
            } else {
                topBarAssemblyEl.classList.remove('hidden');
                topBarAssemblyEl.style.maxHeight = initialTopBarHeight + 'px';
                toggleTopBarButtonEl.style.top = (initialTopBarHeight > 0 ? initialTopBarHeight -1 : 0) + 'px';
                toggleBarIconEl.className = 'fas fa-chevron-up';
                toggleTopBarButtonEl.title = "Hide Toolbar";
            }
        }

        function handleSidebarToggle() {
            isSidebarHidden = !isSidebarHidden;
            const sidebarWidth = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');

            if (isSidebarHidden) {
                sidebarEl.classList.add('hidden'); // Uses margin-left for animation
                // mainContentWrapperEl.style.marginLeft = '0px'; // If sidebar itself animates width to 0
                toggleSidebarIconEl.className = 'fas fa-chevron-right';
                toggleSidebarButtonEl.style.left = '0px';
                toggleSidebarButtonEl.title = "Show Sidebar";
            } else {
                sidebarEl.classList.remove('hidden');
                // mainContentWrapperEl.style.marginLeft = sidebarWidth; // If sidebar itself animates width to 0
                toggleSidebarIconEl.className = 'fas fa-chevron-left';
                toggleSidebarButtonEl.style.left = sidebarWidth;
                toggleSidebarButtonEl.title = "Hide Sidebar";
            }
            // localStorage.setItem('vernSidebarHidden', isSidebarHidden); // Optional: Persist
        }


        function updateInitialTopBarHeight() {
            const wasHidden = topBarAssemblyEl.classList.contains('hidden');
            if (wasHidden) {
                topBarAssemblyEl.classList.remove('hidden');
                topBarAssemblyEl.style.maxHeight = 'none'; // Let it expand fully
            }

            initialTopBarHeight = topBarAssemblyEl.offsetHeight;

            if (wasHidden) {
                topBarAssemblyEl.classList.add('hidden');
                topBarAssemblyEl.style.maxHeight = '0px';
            } else {
                topBarAssemblyEl.style.maxHeight = initialTopBarHeight + 'px';
            }

            if (!isTopBarHidden) {
                toggleTopBarButtonEl.style.top = (initialTopBarHeight > 0 ? initialTopBarHeight -1 : 0) + 'px';
            }
        }

        // --- EVENT HANDLERS ---
        function handleTabBarClick(e) {
            const tabElement = e.target.closest('.tab');
            const closeButton = e.target.closest('.tab-close');
            if (closeButton && tabElement) {
                e.stopPropagation();
                closeTab(tabElement.dataset.tabId);
            } else if (tabElement) {
                activateTab(tabElement.dataset.tabId);
            }
        }

        function handleSearchEnter(e) {
            if (e.key === 'Enter') {
                navigateTo(e.target.value);
            }
        }

        function handleIframeLoad(event) { // Catches load events from iframes
            if (event.target.tagName === 'IFRAME' && event.target.classList.contains('tab-content')) {
                const iframe = event.target;
                const tab = tabs.find(t => t.iframe === iframe);
                if (tab) {
                    tab.isLoading = false;
                    let title = 'Untitled';
                    let currentFrameUrl = tab.url; // Default to the intended URL

                    try {
                        if (iframe.contentWindow && iframe.contentDocument) {
                            title = iframe.contentDocument.title || new URL(tab.url).hostname || 'Untitled';
                             // For UV, the contentWindow.location.href will be the proxied one.
                             // We want to keep tab.url as the original.
                             // If we need to get the *actual* current URL from inside the proxy frame:
                             // This is tricky with cross-origin. UV might post messages for this.
                        }
                    } catch (e) {
                        console.warn(`Could not access iframe content for title/URL for tab ${tab.id} (likely cross-origin or about:blank):`, e.message);
                        try { title = new URL(tab.url).hostname || 'Untitled'; }
                        catch { /* keep 'Untitled' or tab.url */ }
                    }

                    updateTabInfo(tab, title);
                    addToHistory(title, tab.url); // Add to session history on load

                    // Setup title observer if not already (for dynamic title changes post-load)
                    setupTitleObserver(tab);
                }
            }
        }

        function handleWindowMessage(event) {
            // Example: if UV service worker or script inside iframe sends messages
            if (event.data && event.data.type === 'uvLocationChanged') {
                const activeTab = getActiveTab();
                if (activeTab && event.source === activeTab.iframe.contentWindow) {
                    const newUrl = event.data.url; // This should be the decoded, original URL
                    activeTab.url = newUrl;
                    searchBarEl.value = newUrl;
                    updateTabInfo(activeTab, event.data.title || new URL(newUrl).hostname);
                    addToHistory(event.data.title || new URL(newUrl).hostname, newUrl);
                }
            }
             // You can extend this to handle other messages like favicons, etc.
        }


        function handleGlobalKeyDown(e) {
            if (e.target === searchBarEl || e.target.closest('.sidebar-input')) return; // Ignore if typing in inputs

            if ((e.ctrlKey || e.metaKey) && e.key === 't') { e.preventDefault(); createTab('about:blank'); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'w') { e.preventDefault(); if (activeTabId) closeTab(activeTabId); }
            if (e.ctrlKey && e.key === 'Tab') {
                e.preventDefault();
                if (tabs.length > 1) {
                    const currentIndex = tabs.findIndex(t => t.id === activeTabId);
                    const nextIndex = (currentIndex + (e.shiftKey ? -1 : 1) + tabs.length) % tabs.length;
                    activateTab(tabs[nextIndex].id);
                }
            }
            if (e.altKey && e.key === 'ArrowLeft') { e.preventDefault(); backButtonEl.click(); }
            if (e.altKey && e.key === 'ArrowRight') { e.preventDefault(); forwardButtonEl.click(); }
            if (e.key === 'F5' || ((e.ctrlKey || e.metaKey) && e.key === 'r')) { e.preventDefault(); refreshButtonEl.click(); }
            if (e.key === 'F11') { e.preventDefault(); handleTopBarToggle(); }
            // Add more shortcuts (e.g., Ctrl+L to focus search bar)
            if ((e.ctrlKey || e.metaKey) && e.key === 'l') { e.preventDefault(); searchBarEl.focus(); searchBarEl.select(); }
        }

        // --- IFRAME CONTENT TRACKING ---
        function setupTitleObserver(tab) {
            if (!tab || tab.titleObserver || tab.url === 'about:blank') return; // Don't observe blank pages or if already observing

            try {
                const iframeDocument = tab.iframe.contentDocument;
                if (iframeDocument) {
                    const titleEl = iframeDocument.querySelector('title');
                    if (titleEl) {
                        tab.titleObserver = new MutationObserver(() => {
                            if (iframeDocument.title) {
                                updateTabInfo(tab, iframeDocument.title);
                            }
                        });
                        tab.titleObserver.observe(titleEl, { subtree: true, characterData: true, childList: true });
                    }
                }
            } catch (e) {
                // console.warn("Cannot set up title observer for tab (cross-origin):", tab.url, e.message);
                // For cross-origin, rely on initial load title and potential messages from UV
            }
        }

        // --- BOOKMARKS ---
        function loadBookmarks() {
            const bookmarks = JSON.parse(localStorage.getItem('vernBookmarks') || '[]');
            bookmarksListEl.innerHTML = '';
            bookmarks.forEach(bm => renderBookmarkItem(bm));
        }

        function saveBookmarks(bookmarks) {
            localStorage.setItem('vernBookmarks', JSON.stringify(bookmarks));
        }

        function renderBookmarkItem(bookmark) {
            const li = document.createElement('li');
            li.dataset.url = bookmark.url;
            li.title = `${bookmark.name}\n${bookmark.url}`;
            const nameSpan = document.createElement('span');
            nameSpan.textContent = bookmark.name;
            const urlSpan = document.createElement('span');
            urlSpan.className = 'bookmark-url';
            urlSpan.textContent = bookmark.url.length > 30 ? bookmark.url.substring(0, 27) + '...' : bookmark.url;

            const removeBtn = document.createElement('i');
            removeBtn.className = 'fas fa-times';
            removeBtn.style.float = 'right';
            removeBtn.style.cursor = 'pointer';
            removeBtn.style.marginLeft = '5px';
            removeBtn.title = 'Remove bookmark';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removeBookmark(bookmark.url);
            };

            li.appendChild(nameSpan);
            li.appendChild(removeBtn);
            li.appendChild(urlSpan);
            bookmarksListEl.appendChild(li);
        }

        function handleAddCurrentBookmark() {
            const activeTab = getActiveTab();
            if (!activeTab || activeTab.url === 'about:blank' || activeTab.url.startsWith('about:')) {
                alert("Cannot bookmark this page.");
                return;
            }
            const name = newBookmarkNameInputEl.value.trim() || activeTab.title || new URL(activeTab.url).hostname;
            const url = activeTab.url;

            const bookmarks = JSON.parse(localStorage.getItem('vernBookmarks') || '[]');
            if (bookmarks.some(bm => bm.url === url)) {
                alert("This page is already bookmarked.");
                return;
            }
            bookmarks.push({ name, url });
            saveBookmarks(bookmarks);
            renderBookmarkItem({ name, url });
            newBookmarkNameInputEl.value = ''; // Clear input
        }

        function removeBookmark(urlToRemove) {
            let bookmarks = JSON.parse(localStorage.getItem('vernBookmarks') || '[]');
            bookmarks = bookmarks.filter(bm => bm.url !== urlToRemove);
            saveBookmarks(bookmarks);
            loadBookmarks(); // Re-render
        }

        function handleBookmarkClick(e) {
            const li = e.target.closest('li[data-url]');
            if (li) {
                createTab(li.dataset.url);
                if (isSidebarHidden === false && window.innerWidth < 768) { // Auto-hide sidebar on mobile after click
                    handleSidebarToggle();
                }
            }
        }

        // --- SESSION HISTORY ---
        function addToHistory(title, url) {
            if (!url || url === 'about:blank' || url.startsWith('about:')) return; // Don't log blank pages

            // Avoid consecutive duplicates
            if (sessionHistory.length > 0 && sessionHistory[sessionHistory.length - 1].url === url) {
                return;
            }

            sessionHistory.push({ title, url, timestamp: new Date() });
            if (sessionHistory.length > MAX_HISTORY_ITEMS) {
                sessionHistory.shift(); // Keep history to a manageable size
            }
            renderHistory();
        }

        function renderHistory() {
            historyListEl.innerHTML = '';
            // Display in reverse chronological order (newest first)
            [...sessionHistory].reverse().forEach(item => {
                const li = document.createElement('li');
                li.dataset.url = item.url;
                li.title = `${item.title}\n${item.url}\n${item.timestamp.toLocaleTimeString()}`;

                const titleSpan = document.createElement('span');
                titleSpan.textContent = item.title.length > 25 ? item.title.substring(0,22) + '...' : item.title;

                const urlSpan = document.createElement('span');
                urlSpan.className = 'history-url';
                urlSpan.textContent = item.url.length > 30 ? item.url.substring(0, 27) + '...' : item.url;


                li.appendChild(titleSpan);
                li.appendChild(urlSpan);
                historyListEl.appendChild(li);
            });
        }

        function handleHistoryClick(e) {
            const li = e.target.closest('li[data-url]');
            if (li) {
                navigateTo(li.dataset.url); // Navigate in current tab
                if (isSidebarHidden === false && window.innerWidth < 768) { // Auto-hide sidebar on mobile after click
                    handleSidebarToggle();
                }
            }
        }

        // --- THEMES ---
        function applyTheme(themeName) {
            document.body.className = document.body.className.replace(/\btheme-\S+/g, ''); // Remove old theme
            if (themeName !== 'default') {
                document.body.classList.add(`theme-${themeName}`);
            }
            localStorage.setItem('vernTheme', themeName);
            if (themeSelectorEl.value !== themeName) themeSelectorEl.value = themeName;
             // Update toggle button positions if theme affects their initial calculation (shouldn't if CSS vars are robust)
            updateInitialTopBarHeight();
            if (!isSidebarHidden) {
                 toggleSidebarButtonEl.style.left = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
            }

        }

        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('vernTheme') || 'default';
            applyTheme(savedTheme);
        }

        function handleThemeChange(e) {
            applyTheme(e.target.value);
        }

        // --- ADVANCED PAGE LOADING TECHNIQUES ---
        // The primary mechanism here is the Ultraviolet proxy (uv.bundle.js, uv.config.js, register-sw.js).
        // Optimizations would involve:
        // 1. Service Worker Caching:
        //    - `register-sw.js` sets up the service worker. Advanced strategies can be implemented
        //      in the service worker itself (e.g., cache-first for certain assets, stale-while-revalidate).
        //    - Caching proxied content is complex but can yield significant speedups for frequently visited sites.
        // 2. Proxy Server Optimizations (if you host your own Ultraviolet backend):
        //    - Server hardware, network bandwidth.
        //    - Server-side caching (e.g., Redis or Varnish) for proxied requests.
        //    - HTTP/2 or HTTP/3 support on the proxy server.
        //    - Efficient request rewriting and stream handling in the proxy code.
        // 3. Frontend Perceived Performance:
        //    - The current tab system with `display: none` for inactive iframes is good as it preserves state.
        //    - `iframe.loading = 'eager'` for the active tab.
        //    - Optimizing your UI JavaScript (what we're writing here) to be non-blocking.
        //    - Consider preconnecting to the proxy domain if it's different from the main site.
        //      `<link rel="preconnect" href="YOUR_PROXY_DOMAIN_IF_DIFFERENT">`
        // 4. Resource Hints for Proxied Content (Very Advanced & Hard with Generic Proxy):
        //    - If the proxy could parse the HTML of the target page and inject resource hints
        //      (preload, prefetch) for critical assets *through the proxy*, it could speed things up.
        //      This is a significant undertaking for the proxy engine.
        // 5. Intelligent Prefetching (Speculative):
        //    - Based on user habits or links on the current page, you could speculatively start fetching
        //      a URL in a hidden iframe. Resource-intensive and needs careful implementation.

        console.log("Vern Pro Initialized. Advanced page loading relies on the UV proxy and Service Worker capabilities.");

    </script>
</body>
</html>
