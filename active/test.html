<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vern Pro Browser</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/x-icon" href="logo.png" /> <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet" />

    <style id="custom-styles">
        /* Base Elements */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #fff;
            --navbar-bg: rgba(15, 15, 15, 1);
            --navbar-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            --button-bg: rgba(10, 10, 10, 0.8);
            --button-hover-bg: rgba(15, 15, 15, 0.9);
            --search-bg: rgba(10, 10, 10, 0.8);
            --search-focus-bg: rgba(45, 45, 45, 0.9);
            --search-focus-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
            --iframe-bg: #202020;
            --footer-text-color: #fff;
            --font-family-main: 'Roboto Mono', monospace;
            --tab-bg: rgba(25, 25, 25, 0.8);
            --tab-active-bg: rgba(45, 45, 45, 0.9);
            --tab-border: rgba(60, 60, 60, 0.5);
            --tab-hover-bg: rgba(35, 35, 35, 0.9);
            --accent-color: #6d5acd;
            --accent-hover: #584caf;
            --shortcut-bg: rgba(20, 20, 20, 0.9);
            --shortcut-hover: rgba(40, 40, 40, 0.9);
            --sidebar-width: 250px;
            --menu-bg: rgba(30, 30, 30, 0.95);
            --menu-hover: rgba(60, 60, 60, 0.95);
            --menu-border: rgba(70, 70, 70, 0.5);
            --dropdown-bg: rgba(25, 25, 25, 0.98);
            --dropdown-hover: rgba(40, 40, 40, 0.98);
            --dropdown-border: rgba(60, 60, 60, 0.5);
            --modal-bg: rgba(30, 30, 30, 0.98);
            --modal-border: rgba(70, 70, 70, 0.5);
            --modal-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            --tooltip-bg: rgba(15, 15, 15, 0.95);
            --tooltip-border: rgba(70, 70, 70, 0.5);
            --input-bg: rgba(40, 40, 40, 0.95);
            --input-border: rgba(70, 70, 70, 0.5);
            --input-focus-border: var(--accent-color);
            --theme-red: #e74c3c;
            --theme-green: #2ecc71;
            --theme-blue: #3498db;
            --theme-orange: #e67e22;
            --theme-purple: #9b59b6;
            --theme-cyan: #1abc9c;
        }
        html, body {
            margin: 0;
            padding: 0;
            border: none;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: var(--font-family-main);
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        body {
            display: flex;
            flex-direction: column;
        }
        *, *::before, *::after {
            box-sizing: border-box;
        }
        button {
            font-family: var(--font-family-main);
            border: none;
            cursor: pointer;
            background: transparent;
            color: inherit;
        }
        /* Top Bar Assembly */
        #top-bar-assembly {
            overflow: hidden;
            transition: max-height 0.35s ease-in-out;
            /* Set initial max-height via JS for proper first animation */
        }
        #top-bar-assembly.hidden {
            max-height: 0 !important;
        }
        /* Pro Options Bar */
        #pro-options-bar {
            display: flex;
            background-color: var(--navbar-bg);
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: thin;
        }
        #pro-options-bar::-webkit-scrollbar { height: 3px; }
        #pro-options-bar::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.3); border-radius: 3px; }
        .pro-menu-item {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        .pro-menu-item:hover {
            background-color: var(--menu-hover);
        }
        .pro-menu-item i {
            margin-right: 6px;
            font-size: 12px;
        }
        .pro-menu-separator {
            width: 1px;
            background-color: rgba(255, 255, 255, 0.2);
            margin: 0 4px;
        }
        /* Tab Bar */
        #tab-bar {
            display: flex;
            background-color: var(--navbar-bg);
            padding: 10px 12px;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: thin;
            position: relative;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        #tab-bar::-webkit-scrollbar { height: 3px; }
        #tab-bar::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.3); border-radius: 3px; }
        .tab {
            display: flex; align-items: center; min-width: 160px; max-width: 200px; height: 32px;
            padding: 0 12px; background-color: var(--tab-bg); border-radius: 16px; cursor: pointer;
            transition: all 0.2s ease; overflow: hidden; position: relative; box-shadow: 0 0 0 1px var(--tab-border);
        }
        .tab.active {
            background-color: var(--tab-active-bg);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
        }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px; /* Adjust if border-bottom on #tab-bar is thicker */
            left: 10%;
            width: 80%;
            height: 2px;
            background-color: var(--accent-color);
            border-radius: 2px;
        }
        .tab:hover:not(.active) { background-color: var(--tab-hover-bg); }
        .tab-favicon { width: 16px; height: 16px; margin-right: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .tab-favicon img { width: 100%; height: 100%; object-fit: contain; }
        .tab-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; }
        .tab-close { width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-left: 4px; flex-shrink: 0; opacity: 0.7; transition: opacity 0.2s, background-color 0.2s; }
        .tab-close:hover { opacity: 1; background-color: rgba(255, 255, 255, 0.2); }
        .new-tab-button {
            width: 32px; height: 32px; min-width: 32px; margin-left: 6px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; background-color: var(--button-bg);
            cursor: pointer; transition: background-color 0.2s; box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
        }
        .new-tab-button:hover { background-color: var(--button-hover-bg); }
        /* Navigation Bar */
        #nav-bar {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: var(--navbar-bg);
            box-shadow: var(--navbar-shadow);
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
            position: relative; /* For toggle button positioning */
            z-index: 999; /* Above sidebar content but below toggle button if it overlaps */
        }
        #nav-buttons {
            display: flex;
            gap: 8px;
            margin-right: 8px;
        }
        .nav-button {
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background-color: var(--button-bg);
            cursor: pointer; color: var(--text-color); transition: background-color 0.2s, color 0.2s;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        }
        .nav-button:hover { background-color: var(--button-hover-bg); }
        #search-bar {
            flex: 1; height: 40px; border-radius: 30px; border: none; background-color: var(--search-bg);
            color: var(--text-color); padding: 0 18px; font-size: 15px; font-weight: 700;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5); font-family: var(--font-family-main);
        }
        #search-bar:focus { outline: none; background-color: var(--search-focus-bg); box-shadow: var(--search-focus-shadow); font-weight: 700; }
        /* Toggle Top Bar Button */
        #toggle-top-bar-button {
            position: absolute; /* Changed to absolute */
            z-index: 1001;
            width: 40px;
            height: 32px;
            background-color: var(--navbar-bg);
            border-radius: 0 0 100px 100px;
            right: 20px; /* Adjusted for better visibility */
            /* top position is set by JS to be below nav-bar */
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            transition: top 0.35s ease-in-out, background-color 0.2s ease-in-out, transform 0.3s ease-in-out;
            box-shadow:
              -2px 0 0 0 rgba(255, 255, 255, 0.5), /* left */
               2px 0 0 0 rgba(255, 255, 255, 0.5), /* right */
               0 2px 0 0 rgba(255, 255, 255, 0.5); /* bottom */
        }
        #toggle-top-bar-button:hover {
            background-color: var(--button-hover-bg);
        }
        #toggle-top-bar-button .fas {
            font-size: 14px;
            transition: transform 0.3s ease-in-out;
        }
        #toggle-top-bar-button.up .fas {
             transform: rotate(180deg);
        }
        /* Sidebar Toggle Button */
        #toggle-sidebar-button {
            position: absolute; /* Changed to absolute */
            z-index: 1001;
            width: 32px;
            height: 40px;
            background-color: var(--navbar-bg);
            border-radius: 0 100px 100px 0;
            /* left is set by JS */
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            transition: left 0.35s ease-in-out, background-color 0.2s ease-in-out, transform 0.35s ease-in-out;
            box-shadow:
              0 -2px 0 0 rgba(255, 255, 255, 0.5), /* top */
              0 2px 0 0 rgba(255, 255, 255, 0.5), /* bottom */
              2px 0 0 0 rgba(255, 255, 255, 0.5); /* right */
        }
        #toggle-sidebar-button:hover {
            background-color: var(--button-hover-bg);
        }
        #toggle-sidebar-button .fas {
            font-size: 14px;
            transition: transform 0.3s ease-in-out;
        }
        #toggle-sidebar-button.collapsed .fas {
            transform: rotate(180deg);
        }
        /* Sidebar */
        #sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            z-index: 1000;
            transform: translateX(0); /* Initially visible */
            transition: transform 0.35s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        #sidebar.collapsed {
            transform: translateX(calc(-1 * var(--sidebar-width)));
        }
        #sidebar-header {
            padding: 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        #sidebar-logo {
            display: flex;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            text-decoration: none;
            color: var(--text-color);
        }
        #sidebar-logo img { /* Assuming logo.png is your sidebar logo too */
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }
        #sidebar-logo i { /* Fallback if image fails or for an icon logo */
            margin-right: 10px;
            color: var(--accent-color);
        }
        #sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
        }
        .sidebar-section {
            margin-bottom: 20px;
        }
        .sidebar-section-title {
            padding: 0 16px 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .sidebar-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
            text-decoration: none;
            color: var(--text-color);
        }
        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sidebar-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
        }
        .sidebar-item.active {
            background-color: rgba(109, 90, 205, 0.2); /* --accent-color with alpha */
            border-left: 3px solid var(--accent-color);
            padding-left: 13px; /* 16px - 3px */
        }
        .sidebar-item.active i {
            color: var(--accent-color);
        }
        #sidebar-footer {
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-around; /* For multiple icons */
        }
        #sidebar-footer .sidebar-item { padding: 8px; } /* Smaller padding for footer items */

        /* Content Area with Sidebar Support */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: margin-left 0.35s ease;
            margin-left: var(--sidebar-width); /* Initial margin when sidebar is visible */
        }
        #main-content.sidebar-collapsed {
            margin-left: 0;
        }
        /* Tabs Container */
        #tabs-container {
            flex: 1; position: relative; background-color: var(--iframe-bg);
        }
        .tab-content {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; /* Inactive iframes are hidden */
            border: none;
            /* sandbox: allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation allow-pointer-lock allow-modals; */
        }
        .tab-content.active {
            display: block; /* Active iframe is shown */
        }
        /* Shortcuts Grid */
        #shortcuts-container {
            display: none; /* Initially hidden, shown when a new tab is "empty" */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 40px;
            overflow-y: auto;
            background-color: var(--bg-color); /* Or var(--iframe-bg) if preferred */
            z-index: 2; /* Above iframe iframes are also present but hidden */
        }
        #shortcuts-container.active {
            display: block;
        }
        #shortcuts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        #shortcuts-header h1 {
            font-size: 24px;
            margin: 0;
        }
        #shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }
        .shortcut-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            background-color: var(--shortcut-bg);
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            color: var(--text-color); /* Ensure text is visible */
            text-decoration: none; /* If using <a> tags */
        }
        .shortcut-item:hover {
            transform: translateY(-3px);
            background-color: var(--shortcut-hover);
        }
        .shortcut-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--accent-color); /* Default, can be overridden by specific shortcut icon */
            margin-bottom: 10px;
            font-size: 20px;
        }
        .shortcut-icon img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .shortcut-title {
            font-size: 14px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        .shortcut-url {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        .add-shortcut {
            opacity: 0.7;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .add-shortcut:hover {
            opacity: 1;
        }
        .add-shortcut .shortcut-icon {
            background-color: rgba(255, 255, 255, 0.2);
        }
        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1200;
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background-color: var(--modal-bg);
            border-radius: 10px;
            box-shadow: var(--modal-shadow);
            padding: 24px;
            max-width: 500px;
            width: calc(100% - 40px); /* Ensure some padding on small screens */
            border: 1px solid var(--modal-border);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 18px;
            margin: 0;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 22px; /* Larger close icon */
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 5px; /* Easier to click */
        }
        .modal-close:hover {
            opacity: 1;
        }
        .modal-body {
            margin-bottom: 24px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        /* Form elements */
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .form-control {
            width: 100%;
            padding: 10px 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            color: var(--text-color);
            font-family: var(--font-family-main);
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--input-focus-border);
        }
        /* Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-family: var(--font-family-main);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none; /* Ensure no default button border */
        }
        .btn i {
            margin-right: 6px;
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-hover);
        }
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        .btn-danger {
            background-color: var(--theme-red);
            color: white;
        }
        .btn-danger:hover {
            background-color: #c0392b; /* Darker red */
        }
        /* Dropdown menu */
        .dropdown {
            position: relative;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background-color: var(--dropdown-bg);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--dropdown-border);
            min-width: 180px;
            z-index: 1100;
            overflow: hidden; /* Ensure rounded corners clip items */
        }
        .dropdown-menu.show {
            display: block;
        }
        .dropdown-item {
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            color: var(--text-color); /* Ensure text color */
            text-decoration: none; /* If using <a> */
        }
        .dropdown-item:hover {
            background-color: var(--dropdown-hover);
        }
        .dropdown-divider {
            height: 1px;
            background-color: var(--dropdown-border);
            margin: 6px 0;
        }
        /* Settings panels */
        .settings-category {
            margin-bottom: 24px;
        }
        .settings-category-title {
            font-size: 16px;
            margin-bottom: 16px;
            color: var(--accent-color);
            border-bottom: 1px solid var(--tab-border);
            padding-bottom: 8px;
        }
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
        }
        .settings-item-label {
            font-size: 14px;
        }
        /* Toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 22px; /* Height of switch */
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }
        /* Tooltips */
        .tooltip {
            position: relative;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: auto;
            white-space: nowrap;
            background-color: var(--tooltip-bg);
            color: var(--text-color);
            text-align: center;
            border-radius: 6px;
            padding: 6px 10px;
            position: absolute;
            z-index: 1100;
            bottom: 125%; /* Position above the element */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            border: 1px solid var(--tooltip-border);
            pointer-events: none; /* So it doesn't interfere with hover on element */
        }
        .tooltip .tooltip-text::after { /* Arrow for tooltip */
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--tooltip-bg) transparent transparent transparent;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        /* Theme selector */
        .theme-option {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s, border-color 0.2s;
        }
        .theme-option:hover {
            transform: scale(1.1);
        }
        .theme-option.active {
            border-color: white;
            box-shadow: 0 0 5px white;
        }
        .theme-dark { background-color: #1a1a1a; border: 1px solid #555; } /* Added border for visibility if on dark bg */
        .theme-light { background-color: #f5f5f5; border: 1px solid #ccc; }
        .theme-purple-accent { background-color: #6d5acd; } /* Changed to match variable */
        .theme-blue-accent { background-color: #3498db; }
        .theme-green-accent { background-color: #2ecc71; }
        .theme-orange-accent { background-color: #e67e22; }

        .footer-label {
            position: fixed; bottom: 0; left: 0; margin: 1rem; font-family: var(--font-family-main);
            font-size: 0.9rem; color: var(--footer-text-color); text-decoration: none; z-index: 1000;
            opacity: 0.7;
        }
        canvas#backgroundCanvas { /* Added ID for specificity */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none; /* Canvas should not intercept mouse events */
        }
         /* Adjust canvas position based on sidebar */
        body.sidebar-collapsed #backgroundCanvas {
            left: 0;
            width: 100%;
        }
         body:not(.sidebar-collapsed) #backgroundCanvas {
            left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
         }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 200px; /* Smaller sidebar on tablets */
            }
            #shortcuts-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 15px;
            }
            .shortcut-item {
                padding: 12px;
            }
            .shortcut-icon {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            .modal-content {
                width: 90%;
            }
            #pro-options-bar {
                padding: 6px;
                gap: 4px;
            }
            .pro-menu-item {
                padding: 4px 8px;
                font-size: 12px;
            }
            .pro-menu-item i {
                margin-right: 4px;
            }
            .tab {
                 min-width: 140px; max-width: 180px;
            }
             body:not(.sidebar-collapsed) #backgroundCanvas {
                left: var(--sidebar-width);
                width: calc(100% - var(--sidebar-width));
             }
        }
        @media (max-width: 576px) {
            :root {
                --sidebar-width: 100%; /* Full width sidebar on mobile, or hide by default */
            }
             #sidebar.collapsed { /* On mobile, ensure it's fully off-screen if toggled */
                transform: translateX(-100%);
            }
            #main-content.sidebar-collapsed { margin-left: 0; }
            #main-content { margin-left: 0; /* Sidebar might overlay or be hidden by default */ }


            #shortcuts-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
                padding: 20px;
            }
            #shortcuts-container { padding: 20px; }
            .nav-button {
                width: 36px;
                height: 36px;
            }
            #search-bar {
                height: 36px;
                font-size: 14px;
                padding: 0 15px;
            }
            .tab {
                min-width: 100px; /* Further reduce tab size */
                max-width: 130px;
                height: 30px;
                padding: 0 8px;
                font-size: 11px;
            }
            .tab-favicon { width: 14px; height: 14px; margin-right: 5px;}
            .tab-close { font-size: 10px; }
            .new-tab-button { width: 30px; height: 30px; }

            #pro-options-bar { display: none; } /* Example: hide pro options on very small screens */
            #nav-bar { padding: 8px; }
            #toggle-top-bar-button { right: 10px; }

             /* On mobile, canvas position is simpler */
             body.sidebar-collapsed #backgroundCanvas,
             body:not(.sidebar-collapsed) #backgroundCanvas {
                left: 0;
                width: 100%;
             }
        }
    </style>
</head>
<body>
    <canvas id="backgroundCanvas"></canvas>

    <aside id="sidebar">
        <div id="sidebar-header">
            <a href="#" id="sidebar-logo">
                <img src="logo.png" alt="Vern Pro Logo">
                <span>Vern Pro</span>
            </a>
        </div>
        <nav id="sidebar-content">
            <div class="sidebar-section">
                <div class="sidebar-section-title">Navigation</div>
                <a href="#" class="sidebar-item active" data-action="show-home">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="#" class="sidebar-item" data-action="show-bookmarks">
                    <i class="fas fa-bookmark"></i> Bookmarks
                </a>
                <a href="#" class="sidebar-item" data-action="show-history">
                    <i class="fas fa-history"></i> History
                </a>
                <a href="#" class="sidebar-item" data-action="show-downloads">
                    <i class="fas fa-download"></i> Downloads
                </a>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-section-title">Tools</div>
                 <a href="#" class="sidebar-item" data-action="open-devtools">
                    <i class="fas fa-code"></i> Dev Tools
                </a>
                <a href="#" class="sidebar-item" data-action="open-extensions">
                    <i class="fas fa-puzzle-piece"></i> Extensions
                </a>
            </div>
        </nav>
        <div id="sidebar-footer">
            <div class="tooltip">
                <button class="sidebar-item" id="settings-button" data-action="open-settings-modal">
                    <i class="fas fa-cog"></i>
                </button>
                <span class="tooltip-text">Settings</span>
            </div>
             <div class="tooltip">
                <button class="sidebar-item" data-action="show-profile">
                    <i class="fas fa-user-circle"></i>
                </button>
                <span class="tooltip-text">Profile</span>
            </div>
        </div>
    </aside>

    <main id="main-content">
        <div id="top-bar-assembly">
            <div id="pro-options-bar">
                <button class="pro-menu-item" data-action="pro-feature-1"><i class="fas fa-star"></i> Pro Feature 1</button>
                <button class="pro-menu-item" data-action="pro-feature-2"><i class="fas fa-bolt"></i> Pro Feature 2</button>
                <div class="pro-menu-separator"></div>
                <div class="dropdown">
                    <button class="pro-menu-item" id="tools-dropdown-toggle" data-dropdown-target="tools-dropdown-menu"><i class="fas fa-tools"></i> Tools</button>
                    <div class="dropdown-menu" id="tools-dropdown-menu">
                        <a href="#" class="dropdown-item" data-action="tool-snippet"><i class="fas fa-cut"></i> Snippet Tool</a>
                        <a href="#" class="dropdown-item" data-action="tool-colorpicker"><i class="fas fa-palette"></i> Color Picker</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" data-action="tool-help"><i class="fas fa-question-circle"></i> Help</a>
                    </div>
                </div>
            </div>
            <div id="tab-bar">
                <button class="new-tab-button tooltip" id="new-tab-btn">
                    <i class="fas fa-plus"></i>
                    <span class="tooltip-text">New Tab (Ctrl+T)</span>
                </button>
            </div>
        </div>

        <nav id="nav-bar">
            <div id="nav-buttons">
                <button class="nav-button tooltip" id="back-btn" disabled>
                    <i class="fas fa-arrow-left"></i>
                    <span class="tooltip-text">Back (Alt+Left)</span>
                </button>
                <button class="nav-button tooltip" id="forward-btn" disabled>
                    <i class="fas fa-arrow-right"></i>
                    <span class="tooltip-text">Forward (Alt+Right)</span>
                </button>
                <button class="nav-button tooltip" id="reload-btn">
                    <i class="fas fa-redo"></i>
                    <span class="tooltip-text">Reload (F5)</span>
                </button>
                <button class="nav-button tooltip" id="home-btn">
                    <i class="fas fa-home"></i>
                    <span class="tooltip-text">Home</span>
                </button>
            </div>
            <input type="text" id="search-bar" placeholder="Search or enter address">
            <div id="nav-actions" style="display: flex; gap: 8px; margin-left: 8px;">
                 <button class="nav-button tooltip" id="menu-btn" data-action="toggle-user-menu"> <i class="fas fa-ellipsis-v"></i>
                    <span class="tooltip-text">Menu</span>
                </button>
                 <div class="dropdown">
                    <button class="nav-button tooltip" id="user-profile-btn" data-dropdown-target="user-dropdown-menu">
                        <i class="fas fa-user-circle"></i>
                        <span class="tooltip-text">Profile & More</span>
                    </button>
                    <div class="dropdown-menu" id="user-dropdown-menu" style="min-width: 220px;">
                        <div style="padding: 10px 16px; display:flex; align-items:center; border-bottom: 1px solid var(--dropdown-border);">
                            <img src="logo.png" alt="User" style="width:32px; height:32px; border-radius:50%; margin-right:10px;">
                            <div>
                                <div>User Name</div>
                                <div style="font-size:12px; opacity:0.7;">user@example.com</div>
                            </div>
                        </div>
                        <a href="#" class="dropdown-item" data-action="open-settings-modal"><i class="fas fa-cog"></i> Settings</a>
                        <a href="#" class="dropdown-item" data-action="manage-bookmarks"><i class="fas fa-bookmark"></i> Bookmarks</a>
                        <a href="#" class="dropdown-item" data-action="open-history"><i class="fas fa-history"></i> History</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" data-action="sign-out"><i class="fas fa-sign-out-alt"></i> Sign Out</a>
                    </div>
                </div>
            </div>
        </nav>

        <button id="toggle-top-bar-button" class="tooltip">
            <i class="fas fa-chevron-up"></i>
            <span class="tooltip-text">Toggle Toolbar</span>
        </button>

        <div id="tabs-container">
            <div id="shortcuts-container" class="active">
                <div id="shortcuts-header">
                    <h1>Speed Dial</h1>
                    <button class="btn btn-primary" id="manage-shortcuts-btn" data-action="manage-shortcuts"><i class="fas fa-pencil-alt"></i> Manage</button>
                </div>
                <div id="shortcuts-grid">
                     <div class="shortcut-item add-shortcut" id="add-shortcut-btn">
                        <div class="shortcut-icon"><i class="fas fa-plus"></i></div>
                        <div class="shortcut-title">Add Shortcut</div>
                        <div class="shortcut-url"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button id="toggle-sidebar-button" class="tooltip">
        <i class="fas fa-chevron-left"></i>
        <span class="tooltip-text">Toggle Sidebar</span>
    </button>


    <div class="modal" id="add-shortcut-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Shortcut</h3>
                <button class="modal-close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="shortcut-name">Name</label>
                    <input type="text" id="shortcut-name" class="form-control" placeholder="e.g., Google News">
                </div>
                <div class="form-group">
                    <label for="shortcut-url-input">URL</label>
                    <input type="url" id="shortcut-url-input" class="form-control" placeholder="https://news.google.com">
                </div>
                 <div class="form-group">
                    <label for="shortcut-icon-url">Icon URL (Optional)</label>
                    <input type="url" id="shortcut-icon-url" class="form-control" placeholder="https://example.com/icon.png">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="save-shortcut-btn">Save Shortcut</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <div class="settings-category">
                    <h4 class="settings-category-title">Appearance</h4>
                    <div class="settings-item">
                        <span class="settings-item-label">Theme</span>
                        <div>
                            <span class="theme-option theme-dark active" data-theme="dark" title="Dark Theme"></span>
                            <span class="theme-option theme-light" data-theme="light" title="Light Theme"></span>
                            <span class="theme-option theme-purple-accent" data-theme="purple" title="Purple Accent"></span>
                            <span class="theme-option theme-blue-accent" data-theme="blue" title="Blue Accent"></span>
                            <span class="theme-option theme-green-accent" data-theme="green" title="Green Accent"></span>
                            <span class="theme-option theme-orange-accent" data-theme="orange" title="Orange Accent"></span>
                        </div>
                    </div>
                    <div class="settings-item">
                        <span class="settings-item-label">Show Pro Options Bar</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-show-pro-bar" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="settings-item">
                        <span class="settings-item-label">Font Size</span>
                        <select id="setting-font-size" class="form-control" style="width: 120px;">
                            <option value="12px">Small</option>
                            <option value="14px" selected>Medium</option>
                            <option value="16px">Large</option>
                        </select>
                    </div>
                </div>
                <div class="settings-category">
                    <h4 class="settings-category-title">Startup</h4>
                     <div class="settings-item">
                        <span class="settings-item-label">On startup</span>
                        <select id="setting-startup-behavior" class="form-control" style="width: 200px;">
                            <option value="newtab">Open the New Tab page</option>
                            <option value="lastsession">Continue where you left off</option>
                            <option value="homepage">Open a specific page</option>
                        </select>
                    </div>
                    <div class="form-group" id="setting-homepage-url-group" style="display: none;">
                         <label for="setting-homepage-url">Homepage URL</label>
                         <input type="url" id="setting-homepage-url" class="form-control" placeholder="https://example.com">
                    </div>
                </div>
                 <div class="settings-category">
                    <h4 class="settings-category-title">Privacy</h4>
                     <div class="settings-item">
                        <span class="settings-item-label">Clear Browse data</span>
                        <button class="btn btn-secondary" id="clear-browse-data-btn" data-action="clear-browse-data">Clear Data...</button>
                    </div>
                    <div class="settings-item">
                        <span class="settings-item-label">Send "Do Not Track" request</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="setting-do-not-track">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" data-dismiss="modal">Done</button>
            </div>
        </div>
    </div>


    <a href="https://github.com/Lissy93/vern" target="_blank" class="footer-label">Vern Pro (Inspired by Vern)</a>

    <script src="uv/uv.bundle.js" defer></script>
    <script src="uv/uv.config.js" defer></script>
    <script src="register-sw.js" defer></script>
    <script src="search.js" defer></script>


    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Element References
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const toggleSidebarBtn = document.getElementById('toggle-sidebar-button');
            const toggleSidebarIcon = toggleSidebarBtn.querySelector('.fas');

            const topBarAssembly = document.getElementById('top-bar-assembly');
            const navBar = document.getElementById('nav-bar');
            const toggleTopBarBtn = document.getElementById('toggle-top-bar-button');
            const toggleTopBarIcon = toggleTopBarBtn.querySelector('.fas');

            const searchBar = document.getElementById('search-bar');
            const backBtn = document.getElementById('back-btn');
            const forwardBtn = document.getElementById('forward-btn');
            const reloadBtn = document.getElementById('reload-btn');
            const homeBtn = document.getElementById('home-btn');
            const newTabBtn = document.getElementById('new-tab-btn');
            const tabBar = document.getElementById('tab-bar');
            const tabsContainer = document.getElementById('tabs-container');
            const shortcutsContainer = document.getElementById('shortcuts-container');
            const shortcutsGrid = document.getElementById('shortcuts-grid');
            const addShortcutBtn = document.getElementById('add-shortcut-btn'); // Corrected ID


            const addShortcutModal = document.getElementById('add-shortcut-modal');
            const saveShortcutBtn = document.getElementById('save-shortcut-btn');
            const shortcutNameInput = document.getElementById('shortcut-name');
            const shortcutUrlInput = document.getElementById('shortcut-url-input'); // Corrected ID
            const shortcutIconUrlInput = document.getElementById('shortcut-icon-url');


            const settingsModal = document.getElementById('settings-modal');
            const menuBtn = document.getElementById('menu-btn');

            const canvas = document.getElementById('backgroundCanvas');
            const ctx = canvas.getContext('2d');


            let tabs = [];
            let activeTabId = null;
            let nextTabId = 1;
            const MAX_TABS = 15; // Example limit

            const DEFAULT_HOME_PAGE = 'shortcuts'; // Can be a URL or 'shortcuts' which shows speed dial
            const DEFAULT_SEARCH_ENGINE = 'https://duckduckgo.com/?q=%s'; // Default search engine from search.html

            // --- UV Service Worker Initialization ---
            async function initUV() {
                try {
                    if (typeof registerSW === 'function') {
                        await registerSW();
                        console.log("Service worker registered successfully for UV.");
                    } else {
                        console.error("registerSW function not found. Ensure register-sw.js is loaded.");
                        alert("Error: Proxy service worker could not be registered. Website proxying will not work.");
                    }
                } catch (err) {
                    console.error("Failed to register service worker:", err);
                    alert("Error: Proxy service worker registration failed. Website proxying will not work.");
                }
            }
            // await initUV(); // Initialize UV as soon as DOM is ready


            // --- Initial Setup ---
            function initializeBrowser() {
                loadSettings(); // Load theme, shortcuts, etc.

                const startupBehavior = localStorage.getItem('vernProStartupBehavior') || 'newtab';
                let initialUrl = DEFAULT_HOME_PAGE;

                if (startupBehavior === 'lastsession') {
                    // Rudimentary last session restore (can be expanded)
                    const lastActiveTabUrl = localStorage.getItem('vernProLastActiveUrl');
                    if (lastActiveTabUrl) initialUrl = lastActiveTabUrl;
                } else if (startupBehavior === 'homepage') {
                    initialUrl = localStorage.getItem('vernProHomepageUrl') || DEFAULT_HOME_PAGE;
                }

                createNewTab(initialUrl, true);

                updateTopBarAssemblyHeight();
                updateToggleTopBarButtonPosition();
                updateSidebarState();
                updateTopBarState();
                resizeCanvas(); // Initial canvas resize

                // Sidebar items active state and actions
                document.querySelectorAll('#sidebar .sidebar-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        document.querySelectorAll('#sidebar .sidebar-item.active').forEach(active => active.classList.remove('active'));
                        this.classList.add('active');
                        const action = this.dataset.action;
                        handleSidebarAction(action);
                    });
                });

                // Pro Options Bar actions (placeholders)
                document.querySelectorAll('#pro-options-bar .pro-menu-item, #tools-dropdown-menu .dropdown-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const action = this.dataset.action || this.textContent.trim();
                        alert(`Action: ${action} (not implemented yet)`);
                    });
                });

                // Nav bar menu button action
                if(menuBtn) {
                    menuBtn.addEventListener('click', () => {
                         const userDropdownMenu = document.getElementById('user-dropdown-menu');
                         if(userDropdownMenu) userDropdownMenu.classList.toggle('show');
                    });
                }

                // Manage Shortcuts button
                document.getElementById('manage-shortcuts-btn')?.addEventListener('click', () => {
                    alert('Manage Shortcuts functionality not yet implemented.');
                });
            }

            // --- Sidebar Toggle ---
            toggleSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('sidebar-collapsed');
                document.body.classList.toggle('sidebar-collapsed'); // Toggle class on body for canvas
                toggleSidebarIcon.classList.toggle('fa-chevron-left');
                toggleSidebarIcon.classList.toggle('fa-chevron-right');
                toggleSidebarBtn.classList.toggle('collapsed');

                if (sidebar.classList.contains('collapsed')) {
                    toggleSidebarBtn.style.left = '0px';
                    localStorage.setItem('sidebarCollapsed', 'true');
                } else {
                    toggleSidebarBtn.style.left = sidebar.offsetWidth + 'px'; // Position next to open sidebar
                    localStorage.setItem('sidebarCollapsed', 'false');
                }
                 // Adjust toggle button position after transition
                 setTimeout(() => {
                     const sidebarWidth = sidebar.classList.contains('collapsed') ? 0 : sidebar.offsetWidth;
                      toggleSidebarBtn.style.left = sidebarWidth + 'px';
                 }, 350); // Match CSS transition duration


                setTimeout(updateToggleTopBarButtonPosition, 350);
                setTimeout(resizeCanvas, 350); // Resize canvas after sidebar transition
            });

             function updateSidebarState() {
                const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
                if (isCollapsed) {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('sidebar-collapsed');
                    document.body.classList.add('sidebar-collapsed'); // Apply to body
                    toggleSidebarIcon.classList.remove('fa-chevron-left');
                    toggleSidebarIcon.classList.add('fa-chevron-right');
                    toggleSidebarBtn.classList.add('collapsed');
                    toggleSidebarBtn.style.left = '0px';
                } else {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('sidebar-collapsed');
                     document.body.classList.remove('sidebar-collapsed'); // Remove from body
                    toggleSidebarIcon.classList.add('fa-chevron-left');
                    toggleSidebarIcon.classList.remove('fa-chevron-right');
                    toggleSidebarBtn.classList.remove('collapsed');
                    toggleSidebarBtn.style.left = sidebar.offsetWidth + 'px'; // Position next to sidebar initially
                }
                 setTimeout(() => { // Re-adjust after potential initial transition
                     const sidebarWidth = sidebar.classList.contains('collapsed') ? 0 : sidebar.offsetWidth;
                      toggleSidebarBtn.style.left = sidebarWidth + 'px';
                 }, 350);
            }


            // --- Top Bar Assembly Toggle (Pro Options + Tabs) ---
            function updateTopBarAssemblyHeight() {
                 // Temporarily remove transition to measure scrollHeight accurately
                topBarAssembly.style.transition = 'none';
                if (!topBarAssembly.classList.contains('hidden')) {
                     topBarAssembly.style.maxHeight = topBarAssembly.scrollHeight + 'px';
                } else {
                    topBarAssembly.style.maxHeight = '0px';
                }
                 // Re-add transition after a slight delay to allow measurement
                requestAnimationFrame(() => {
                     requestAnimationFrame(() => { // Double rAF for sure
                        topBarAssembly.style.transition = 'max-height 0.35s ease-in-out';
                     });
                });
            }

            function updateToggleTopBarButtonPosition() {
                const navBarHeight = navBar.offsetHeight;
                toggleTopBarBtn.style.top = navBarHeight + 'px';
            }

            toggleTopBarBtn.addEventListener('click', () => {
                topBarAssembly.classList.toggle('hidden');
                toggleTopBarIcon.classList.toggle('fa-chevron-up');
                toggleTopBarIcon.classList.toggle('fa-chevron-down');
                toggleTopBarBtn.classList.toggle('up', !topBarAssembly.classList.contains('hidden'));

                if (topBarAssembly.classList.contains('hidden')) {
                    topBarAssembly.style.maxHeight = '0px';
                    localStorage.setItem('topBarHidden', 'true');
                } else {
                    // Set max-height after toggling class to enable expand animation
                     setTimeout(() => {
                         topBarAssembly.style.maxHeight = topBarAssembly.scrollHeight + 'px';
                     }, 0);
                     localStorage.setItem('topBarHidden', 'false');
                }
                 // Resize canvas after top bar transition
                 setTimeout(resizeCanvas, 350); // Match CSS transition duration
            });

             function updateTopBarState() {
                const isHidden = localStorage.getItem('topBarHidden') === 'true';
                if (isHidden) {
                    topBarAssembly.classList.add('hidden');
                    toggleTopBarIcon.classList.remove('fa-chevron-up');
                    toggleTopBarIcon.classList.add('fa-chevron-down');
                    topBarAssembly.style.maxHeight = '0px';
                } else {
                    topBarAssembly.classList.remove('hidden');
                    toggleTopBarIcon.classList.add('fa-chevron-up');
                    toggleTopBarIcon.classList.remove('fa-chevron-down');
                     // Set max-height after removing 'hidden' class
                    setTimeout(() => {
                         updateTopBarAssemblyHeight(); // Recalculate and set
                    }, 0);
                }
                toggleTopBarBtn.classList.toggle('up', !topBarAssembly.classList.contains('hidden'));
                setTimeout(resizeCanvas, 350); // Resize canvas after initial state setup
            }


            window.addEventListener('resize', () => {
                updateTopBarAssemblyHeight(); // Recalculate height on resize
                updateToggleTopBarButtonPosition();
                resizeCanvas(); // Resize canvas on window resize
            });


            // --- Canvas Resizing ---
            function resizeCanvas() {
                 // The canvas is fixed and covers the whole viewport.
                 // Its *visual* appearance is adjusted by CSS margins on main-content.
                 // We just need to ensure its internal drawing buffer size matches the viewport.
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                // Redraw background here if needed, or handle in a dedicated canvas animation function
            }


            // --- Tab Management ---
            function createNewTab(url = DEFAULT_HOME_PAGE, makeActive = true) {
                if (tabs.length >= MAX_TABS) {
                    alert("Maximum number of tabs reached.");
                    return null;
                }

                const tabId = `tab-${nextTabId++}`;
                const tabData = {
                    id: tabId,
                    url: url, // This will be the "target" URL, not the proxied one initially
                    actualUrl: url, // Store the original requested URL
                    title: 'New Tab',
                    favicon: 'logo.png',
                    isLoading: true,
                    history: [url],
                    historyIndex: 0,
                    iframe: null,
                    locationCheckIntervalId: null // For tracking iframe internal navigation
                };
                tabs.push(tabData);

                const tabEl = document.createElement('div');
                tabEl.className = 'tab';
                tabEl.dataset.tabId = tabId;
                tabEl.innerHTML = `
                    <span class="tab-favicon"><img src="${tabData.favicon}" alt=""></span>
                    <span class="tab-title">${tabData.title}</span>
                    <button class="tab-close"><i class="fas fa-times"></i></button>
                `;
                tabBar.insertBefore(tabEl, newTabBtn);

                const contentEl = document.createElement('div');
                contentEl.id = `content-${tabId}`;
                contentEl.className = 'tab-content';
                tabsContainer.appendChild(contentEl);
                tabData.contentEl = contentEl;

                if (url !== 'shortcuts') {
                    const iframe = document.createElement('iframe');
                    // iframe.sandbox = "allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation allow-pointer-lock allow-modals";
                    iframe.addEventListener('load', () => handleIframeLoad(tabData, iframe));
                    iframe.addEventListener('error', () => handleIframeError(tabData, iframe));
                    contentEl.appendChild(iframe);
                    tabData.iframe = iframe;
                }

                tabEl.querySelector('.tab-close').addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeTab(tabId);
                });
                tabEl.addEventListener('click', () => switchToTab(tabId));

                if (makeActive) {
                    switchToTab(tabId);
                } else {
                    updateTabVisuals();
                }
                // Navigate after tab structure is set up if it's an active new tab, or if switching will handle it
                if (makeActive) {
                     navigate(url, tabData); // Initial navigation for the new tab
                }
                updateTopBarAssemblyHeight(); // Recalculate top bar height when a new tab is added
                return tabData;
            }

            function switchToTab(tabId) {
                if (activeTabId === tabId && document.querySelector(`.tab[data-tab-id="${tabId}"]`)?.classList.contains('active')) return;

                tabs.forEach(tab => {
                    const tabEl = document.querySelector(`.tab[data-tab-id="${tab.id}"]`);
                    // const contentEl = document.getElementById(`content-${tab.id}`);
                    if (tabEl) tabEl.classList.remove('active');
                    if (tab.contentEl) tab.contentEl.classList.remove('active');
                    if(tab.locationCheckIntervalId) clearInterval(tab.locationCheckIntervalId); // Stop tracking non-active tabs
                });

                shortcutsContainer.classList.remove('active');
                activeTabId = tabId;
                const activeTabData = tabs.find(t => t.id === tabId);

                if (activeTabData) {
                    const activeTabEl = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
                    if (activeTabEl) activeTabEl.classList.add('active');

                    document.title = (activeTabData.title || 'Vern Pro') + ' - Vern Pro Browser';

                    if (activeTabData.url === 'shortcuts') {
                        searchBar.value = '';
                        shortcutsContainer.classList.add('active');
                        if(activeTabData.contentEl) activeTabData.contentEl.classList.remove('active');
                    } else {
                        if (activeTabData.contentEl) activeTabData.contentEl.classList.add('active');
                        // If iframe doesn't exist yet (e.g., was shortcuts, now navigating), create it.
                        if (!activeTabData.iframe && activeTabData.contentEl) {
                            const iframe = document.createElement('iframe');
                            // iframe.sandbox = "allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation allow-pointer-lock allow-modals";
                            iframe.addEventListener('load', () => handleIframeLoad(activeTabData, iframe));
                            iframe.addEventListener('error', () => handleIframeError(activeTabData, iframe));
                            activeTabData.contentEl.innerHTML = ''; // Clear any previous non-iframe content
                            activeTabData.contentEl.appendChild(iframe);
                            activeTabData.iframe = iframe;
                            navigate(activeTabData.url, activeTabData); // Navigate this newly created iframe
                        } else {
                             // update searchBar with the actual URL if available, otherwise the target one.
                            searchBar.value = activeTabData.actualUrl || activeTabData.url;
                        }
                        trackIframeLocation(activeTabData); // Start tracking for this active tab
                    }
                    updateNavButtons(activeTabData);
                    localStorage.setItem('vernProLastActiveUrl', activeTabData.actualUrl || activeTabData.url);
                }
                updateTabVisuals();
            }

            function closeTab(tabId) {
                const tabIndex = tabs.findIndex(t => t.id === tabId);
                if (tabIndex === -1) return;

                const tabToClose = tabs[tabIndex];
                if (tabToClose.locationCheckIntervalId) {
                    clearInterval(tabToClose.locationCheckIntervalId);
                }

                const tabEl = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
                // const contentEl = document.getElementById(`content-${tabId}`);
                if (tabEl) tabEl.remove();
                if (tabToClose.contentEl) tabToClose.contentEl.remove();

                tabs.splice(tabIndex, 1);

                if (activeTabId === tabId) {
                    activeTabId = null;
                    if (tabs.length > 0) {
                        switchToTab(tabs[Math.max(0, tabIndex - 1)].id);
                    } else {
                        createNewTab(DEFAULT_HOME_PAGE);
                    }
                } else if (tabs.length === 0) {
                     createNewTab(DEFAULT_HOME_PAGE);
                }
                updateTabVisuals();
                updateTopBarAssemblyHeight(); // Recalculate top bar height when a tab is closed
            }

            function updateTabElement(tabData) {
                const tabEl = document.querySelector(`.tab[data-tab-id="${tabData.id}"]`);
                if (tabEl) {
                    tabEl.querySelector('.tab-title').textContent = tabData.isLoading ? 'Loading...' : (tabData.title || 'Untitled');
                    tabEl.querySelector('.tab-title').title = tabData.isLoading ? 'Loading...' : (tabData.title || 'Untitled');

                    const faviconEl = tabEl.querySelector('.tab-favicon');
                    if(tabData.isLoading) {
                        faviconEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    } else {
                        faviconEl.innerHTML = `<img src="${tabData.favicon || 'logo.png'}" alt="" onerror="this.src='logo.png'">`;
                    }
                }
                if (tabData.id === activeTabId) {
                     document.title = (tabData.title || 'Vern Pro') + ' - Vern Pro Browser';
                }
            }

            function trackIframeLocation(tabData) {
                if (!tabData || !tabData.iframe || tabData.url === 'shortcuts') return;

                if (tabData.locationCheckIntervalId) clearInterval(tabData.locationCheckIntervalId);

                tabData.locationCheckIntervalId = setInterval(() => {
                    if (tabData.id !== activeTabId || !tabData.iframe || !tabData.iframe.contentWindow) {
                        clearInterval(tabData.locationCheckIntervalId);
                        return;
                    }
                    try {
                        const currentIframeSrc = tabData.iframe.contentWindow.location.href;
                        // The UV proxied URL will be in iframe.src or iframe.contentWindow.location.href
                        // We need to decode it to get the "actual" URL
                        if (currentIframeSrc && currentIframeSrc !== 'about:blank' && currentIframeSrc !== tabData.proxiedUrl) {
                             if (typeof __uv$config !== 'undefined' && typeof __uv$config.decodeUrl === 'function' && currentIframeSrc.includes(__uv$config.prefix)) {
                                const encodedPart = currentIframeSrc.substring(currentIframeSrc.indexOf(__uv$config.prefix) + __uv$config.prefix.length);
                                let decodedActualUrl = '';
                                try {
                                   decodedActualUrl = __uv$config.decodeUrl(encodedPart);
                                } catch (e) { console.warn("Error decoding URL from iframe src:", e); decodedActualUrl = "error decoding URL"; }

                                if (decodedActualUrl && decodedActualUrl !== tabData.actualUrl) {
                                    tabData.actualUrl = decodedActualUrl; // Update the actual URL
                                    // Update history if navigation wasn't through back/forward
                                    if (tabData.history[tabData.historyIndex] !== decodedActualUrl) {
                                        if (tabData.historyIndex < tabData.history.length - 1) {
                                            tabData.history = tabData.history.slice(0, tabData.historyIndex + 1);
                                        }
                                        tabData.history.push(decodedActualUrl);
                                        tabData.historyIndex = tabData.history.length - 1;
                                        updateNavButtons(tabData);
                                    }
                                    tabData.url = decodedActualUrl; // Ensure main url is the actual one
                                    if (tabData.id === activeTabId) {
                                        searchBar.value = decodedActualUrl; // Update search bar
                                    }
                                }
                             } else {
                                 // Not a proxied URL, treat as actual
                                 if (currentIframeSrc !== tabData.actualUrl) {
                                     tabData.actualUrl = currentIframeSrc;
                                      if (tabData.history[tabData.historyIndex] !== currentIframeSrc) {
                                        if (tabData.historyIndex < tabData.history.length - 1) {
                                            tabData.history = tabData.history.slice(0, tabData.historyIndex + 1);
                                        }
                                        tabData.history.push(currentIframeSrc);
                                        tabData.historyIndex = tabData.history.length - 1;
                                        updateNavButtons(tabData);
                                    }
                                    tabData.url = currentIframeSrc;
                                    if (tabData.id === activeTabId) {
                                        searchBar.value = currentIframeSrc;
                                    }
                                 }
                             }
                        }
                    } catch (e) {
                        // console.warn("CORS error trying to access iframe location for tracking, or iframe detached.", e);
                        // This often happens briefly during navigation or if iframe is cross-origin before UV kicks in fully
                         clearInterval(tabData.locationCheckIntervalId); // Stop tracking if access fails
                    }
                }, 500); // Check periodically
            }


            function handleIframeLoad(tabData, iframe) {
                tabData.isLoading = false;
                let pageTitle = 'Untitled';
                let pageFavicon = 'logo.png';
                let actualUrl = tabData.actualUrl || tabData.url; // Prefer actualUrl if set by UV process

                try {
                    if (iframe.contentDocument) {
                        pageTitle = iframe.contentDocument.title || new URL(iframe.src).hostname;
                         const links = iframe.contentDocument.getElementsByTagName('link');
                        for (let link of links) {
                            if (link.rel.includes('icon')) {
                                pageFavicon = new URL(link.href, iframe.src).href;
                                break;
                            }
                        }
                    }
                } catch (e) {
                    // CORS or other security error, fallback to URL parts
                    console.warn("CORS issue accessing iframe content for title/favicon after load.", e);
                    try {
                         // Attempt to get hostname from iframe src, handling proxied URLs
                         if (typeof __uv$config !== 'undefined' && iframe.src.includes(__uv$config.prefix)) {
                              const encodedPart = iframe.src.substring(iframe.src.indexOf(__uv$config.prefix) + __uv$config.prefix.length);
                              let decodedUrl = '';
                              try { decodedUrl = __uv$config.decodeUrl(encodedPart); } catch(e) { console.warn("Failed to decode URL for hostname", e); }
                               if (decodedUrl) pageTitle = new URL(decodedUrl).hostname;
                         } else {
                             pageTitle = new URL(iframe.src).hostname;
                         }

                    } catch { /* keep default */ }
                }

                // If UV is used, try to get the decoded URL for display and history
                if (typeof __uv$config !== 'undefined' && typeof __uv$config.prefix !== 'undefined' && typeof __uv$config.decodeUrl === 'function' && iframe.src.includes(__uv$config.prefix)) {
                    const encodedPart = iframe.src.substring(iframe.src.indexOf(__uv$config.prefix) + __uv$config.prefix.length);
                    try {
                        const decodedUrl = __uv$config.decodeUrl(encodedPart);
                        actualUrl = decodedUrl; // This is the "real" URL
                         pageTitle = iframe.contentDocument?.title || new URL(actualUrl).hostname; // Use actual URL for title if doc title fails
                    } catch (e) { console.warn("Error decoding UV URL on load:", e); actualUrl = "Failed to decode URL"; }
                } else if (iframe.src !== 'about:blank' && iframe.src !== 'shortcuts'){
                     actualUrl = iframe.src; // Non-proxied URL
                }


                tabData.title = pageTitle;
                tabData.favicon = pageFavicon || `https://www.google.com/s2/favicons?domain=${new URL(actualUrl.startsWith('http') ? actualUrl : 'https://' + actualUrl).hostname}&sz=32`;
                tabData.actualUrl = actualUrl; // Store the "real" URL
                tabData.proxiedUrl = iframe.src; // Store the current src of the iframe (could be proxied)


                // Update URL history for back/forward using the actual (decoded) URL
                if (tabData.history[tabData.historyIndex] !== actualUrl && actualUrl !== 'about:blank') {
                     // Check if the current actualUrl is already the next entry in history (e.g., from a redirect)
                    if (!(tabData.historyIndex < tabData.history.length - 1 && tabData.history[tabData.historyIndex + 1] === actualUrl)) {
                         if (tabData.historyIndex < tabData.history.length - 1) {
                            tabData.history = tabData.history.slice(0, tabData.historyIndex + 1);
                        }
                        tabData.history.push(actualUrl);
                        tabData.historyIndex = tabData.history.length - 1;
                    } else {
                         // It's a redirect, just advance history index if needed
                         tabData.historyIndex++;
                    }
                }
                 // If the URL is already in history, just update the index (happens with back/forward clicks)
                 const existingHistoryIndex = tabData.history.indexOf(actualUrl);
                 if (existingHistoryIndex !== -1 && existingHistoryIndex !== tabData.historyIndex) {
                     tabData.historyIndex = existingHistoryIndex;
                 }


                tabData.url = actualUrl; // Ensure main url is the actual one

                if (tabData.id === activeTabId) {
                    searchBar.value = actualUrl === 'about:blank' ? '' : actualUrl;
                    updateNavButtons(tabData);
                }
                updateTabElement(tabData);
                trackIframeLocation(tabData); // Start/restart tracking after load
            }

            function handleIframeError(tabData, iframe){
                tabData.isLoading = false;
                tabData.title = "Error Loading Page";
                tabData.favicon = 'logo.png';
                try {
                    if(iframe && iframe.contentDocument) { // Check if iframe and its document exist
                        iframe.contentDocument.body.innerHTML = `<div style="padding:20px; text-align:center; color: white;"><h2>Failed to load page</h2><p>${tabData.actualUrl || tabData.url}</p></div>`;
                         // Prevent history update on error page load unless it's the initial load
                        if (tabData.history.length > 1 || tabData.history[0] !== (tabData.actualUrl || tabData.url)) {
                             // Only add to history if not the very first entry or if navigating away from a valid page
                            const errorUrl = "about:error?url=" + encodeURIComponent(tabData.actualUrl || tabData.url);
                            if (tabData.history[tabData.historyIndex] !== errorUrl) {
                                 if (tabData.historyIndex < tabData.history.length - 1) {
                                    tabData.history = tabData.history.slice(0, tabData.historyIndex + 1);
                                }
                                tabData.history.push(errorUrl);
                                tabData.historyIndex = tabData.history.length - 1;
                            }
                        }
                    } else {
                         console.warn("Could not write error to iframe body (likely due to navigation change or removal).");
                          // Handle history update even if cannot write to iframe
                           const errorUrl = "about:error?url=" + encodeURIComponent(tabData.actualUrl || tabData.url);
                            if (tabData.history[tabData.historyIndex] !== errorUrl) {
                                 if (tabData.historyIndex < tabData.history.length - 1) {
                                    tabData.history = tabData.history.slice(0, tabData.historyIndex + 1);
                                }
                                tabData.history.push(errorUrl);
                                tabData.historyIndex = tabData.history.length - 1;
                            }
                    }
                } catch (e) {
                    console.warn("Error handling iframe error:", e);
                }
                updateTabElement(tabData);
                 if (tabData.id === activeTabId) {
                    updateNavButtons(tabData);
                    searchBar.value = "Error Loading: " + (tabData.actualUrl || tabData.url); // Indicate error in search bar
                }
                 if(tabData.locationCheckIntervalId) clearInterval(tabData.locationCheckIntervalId); // Stop tracking on error
            }


            function updateTabVisuals() {
                if (tabBar.scrollWidth > tabBar.clientWidth) {
                    tabBar.classList.add('has-scroll');
                } else {
                    tabBar.classList.remove('has-scroll');
                }
            }

            newTabBtn.addEventListener('click', () => createNewTab(DEFAULT_HOME_PAGE));

            // --- Navigation ---
            function navigate(urlInput, tab = null) {
                let currentTab = tab || tabs.find(t => t.id === activeTabId);
                if (!currentTab) {
                    console.error("Navigate: No active tab found. Creating new tab.");
                    currentTab = createNewTab(urlInput, true); // Create one and make it active
                    if(!currentTab) return; // If tab creation failed (e.g. max tabs)
                } else {
                    // If navigating the current tab, mark as loading immediately
                    currentTab.isLoading = true;
                    updateTabElement(currentTab);
                     if (currentTab.id === activeTabId) {
                        updateNavButtons(currentTab); // Update buttons state (e.g., disable reload)
                     }
                }


                if (urlInput === 'shortcuts' || urlInput === 'about:blank') {
                    currentTab.url = urlInput;
                    currentTab.actualUrl = urlInput;
                    currentTab.title = urlInput === 'shortcuts' ? 'Speed Dial' : 'New Tab';
                    currentTab.favicon = 'logo.png';
                    currentTab.isLoading = false; // Shortcuts/Blank is not loading in the same sense

                    if (currentTab.iframe) {
                        currentTab.iframe.src = 'about:blank'; // Clear iframe content
                    }
                     if(currentTab.contentEl && currentTab.url === 'shortcuts') {
                        currentTab.contentEl.classList.remove('active'); // Hide its iframe container
                    }

                    // Update history for 'shortcuts' or 'about:blank' pages
                    if (currentTab.history[currentTab.historyIndex] !== urlInput) {
                         if (currentTab.historyIndex < currentTab.history.length - 1) {
                            currentTab.history = currentTab.history.slice(0, currentTab.historyIndex + 1);
                        }
                        currentTab.history.push(urlInput);
                        currentTab.historyIndex = currentTab.history.length - 1;
                    } else {
                         // If already in history (back/forward), just update index
                        const existingIndex = currentTab.history.indexOf(urlInput);
                        if(existingIndex !== -1) currentTab.historyIndex = existingIndex;
                    }


                    if (urlInput === 'shortcuts') {
                        shortcutsContainer.classList.add('active');
                        loadShortcuts(); // Reload shortcuts when showing the page
                    } else {
                        shortcutsContainer.classList.remove('active');
                         if(currentTab.contentEl) currentTab.contentEl.classList.add('active'); // Show its content div if it's about:blank
                         // If the iframe was just created and is about:blank, handleLoad will be called.
                         // If it already existed and we set src to about:blank, handleLoad might not fire consistently,
                         // but the visual is cleared.
                    }

                    updateTabElement(currentTab);
                    if (currentTab.id === activeTabId) {
                        searchBar.value = ''; // Clear search bar for shortcuts/blank
                        updateNavButtons(currentTab);
                    }
                    if(currentTab.locationCheckIntervalId) clearInterval(currentTab.locationCheckIntervalId); // Stop tracking for internal pages
                    return;
                }

                shortcutsContainer.classList.remove('active');
                 if(currentTab.contentEl) currentTab.contentEl.classList.add('active'); // Ensure content area is visible for iframe

                // Ensure iframe exists if navigating away from shortcuts
                if (!currentTab.iframe && currentTab.contentEl) {
                    const iframe = document.createElement('iframe');
                    // iframe.sandbox = "allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation allow-pointer-lock allow-modals";
                    iframe.addEventListener('load', () => handleIframeLoad(currentTab, iframe));
                    iframe.addEventListener('error', () => handleIframeError(currentTab, iframe));
                    currentTab.contentEl.innerHTML = '';
                    currentTab.contentEl.appendChild(iframe);
                    currentTab.iframe = iframe;
                }


                // UV Proxy integration from search.html
                let formattedUrl;
                if (typeof searchFast === 'function') {
                    formattedUrl = searchFast(urlInput, DEFAULT_SEARCH_ENGINE);
                } else {
                    console.warn("searchFast function not found. Using basic URL parsing.");
                    // Basic parsing if searchFast is unavailable
                    if (!urlInput.startsWith('http://') && !urlInput.startsWith('https://') && !urlInput.startsWith('file://')) {
                        if (urlInput.includes('.') && !urlInput.includes(' ')) {
                            formattedUrl = 'https://' + urlInput;
                        } else {
                            formattedUrl = DEFAULT_SEARCH_ENGINE.replace('%s', encodeURIComponent(urlInput));
                        }
                    } else {
                        formattedUrl = urlInput;
                    }
                }

                // Update history before navigation happens in the iframe
                 if (currentTab.history[currentTab.historyIndex] !== formattedUrl) {
                    if (currentTab.historyIndex < currentTab.history.length - 1) {
                        currentTab.history = currentTab.history.slice(0, currentTab.historyIndex + 1);
                    }
                    currentTab.history.push(formattedUrl);
                    currentTab.historyIndex = currentTab.history.length - 1;
                 } else {
                    // If the URL is already the current history entry (e.g., hitting enter again),
                    // just reload the current history entry.
                 }


                currentTab.actualUrl = formattedUrl; // Store the target URL
                if (currentTab.id === activeTabId) {
                    searchBar.value = formattedUrl; // Update search bar immediately with target
                    updateNavButtons(currentTab);
                }


                if (typeof __uv$config === 'undefined' || typeof __uv$config.prefix === 'undefined' || typeof __uv$config.encodeUrl === 'undefined') {
                    console.error("UV configuration (__uv$config) is not available. Website proxying will not work.");
                    alert("UV Proxy not configured. Cannot load website.");
                    handleIframeError(currentTab, currentTab.iframe);
                    return;
                }

                try {
                    const encodedUrl = __uv$config.prefix + __uv$config.encodeUrl(formattedUrl);
                    currentTab.proxiedUrl = encodedUrl;
                    if(currentTab.iframe) currentTab.iframe.src = encodedUrl;
                    else {
                         console.error("Navigate: Iframe not found for tab " + currentTab.id);
                         handleIframeError(currentTab, null);
                         return;
                    }
                } catch (err) {
                    console.error("Navigation error with UV:", err);
                    handleIframeError(currentTab, currentTab.iframe);
                }
                trackIframeLocation(currentTab); // Start tracking on navigation
            }


            searchBar.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    navigate(searchBar.value);
                     searchBar.blur(); // Remove focus after navigating
                }
            });

            reloadBtn.addEventListener('click', () => {
                const currentTab = tabs.find(t => t.id === activeTabId);
                if (currentTab) {
                    if (currentTab.url === 'shortcuts') {
                        loadShortcuts(); // "Reload" shortcuts
                    } else if (currentTab.iframe && currentTab.iframe.contentWindow) {
                         currentTab.isLoading = true;
                         updateTabElement(currentTab);
                         updateNavButtons(currentTab); // Disable reload button
                        try {
                            // Attempt to reload the iframe directly first
                            currentTab.iframe.contentWindow.location.reload(true); // true for force reload
                             // History is not affected by iframe.contentWindow.location.reload()
                        } catch (e) {
                             console.warn("Error reloading iframe directly, attempting re-navigation:", e);
                             // Fallback to re-navigate using the current actual URL
                             if(currentTab.actualUrl && currentTab.actualUrl !== 'about:blank' && currentTab.actualUrl !== 'shortcuts') {
                                // Simulate navigation to the current actual URL, this will update history if needed.
                                navigate(currentTab.actualUrl, currentTab);
                             } else {
                                // If actualUrl is blank/shortcuts, just mark loading false and update buttons
                                tabData.isLoading = false;
                                updateTabElement(tabData);
                                updateNavButtons(tabData);
                             }
                        }
                    }
                }
            });

            homeBtn.addEventListener('click', () => navigate(DEFAULT_HOME_PAGE));

            backBtn.addEventListener('click', () => {
                const currentTab = tabs.find(t => t.id === activeTabId);
                if (currentTab && currentTab.historyIndex > 0) {
                    currentTab.historyIndex--;
                    const targetUrl = currentTab.history[currentTab.historyIndex];
                    currentTab.isLoading = true;
                    updateTabElement(currentTab);
                    updateNavButtons(currentTab); // Update button states immediately
                    navigate(targetUrl, currentTab); // Navigate to the previous history entry
                } else if (currentTab && currentTab.iframe && currentTab.iframe.contentWindow) {
                    // Fallback if history array is not perfectly synced, try iframe's own history
                    try { currentTab.iframe.contentWindow.history.back(); } catch(e) {console.warn("iframe history.back() failed", e)}
                }
            });

            forwardBtn.addEventListener('click', () => {
                const currentTab = tabs.find(t => t.id === activeTabId);
                 if (currentTab && currentTab.historyIndex < currentTab.history.length - 1) {
                    currentTab.historyIndex++;
                    const targetUrl = currentTab.history[currentTab.historyIndex];
                    currentTab.isLoading = true;
                    updateTabElement(currentTab);
                    updateNavButtons(currentTab); // Update button states immediately
                    navigate(targetUrl, currentTab); // Navigate to the next history entry
                } else if (currentTab && currentTab.iframe && currentTab.iframe.contentWindow) {
                     try { currentTab.iframe.contentWindow.history.forward(); } catch(e) {console.warn("iframe history.forward() failed", e)}
                }
            });

            function updateNavButtons(tabData) {
                if (!tabData) {
                    backBtn.disabled = true;
                    forwardBtn.disabled = true;
                    reloadBtn.disabled = true;
                    return;
                }
                reloadBtn.disabled = tabData.isLoading;
                // Buttons are disabled if there's no history entry to go back/forward to
                backBtn.disabled = tabData.historyIndex <= 0;
                forwardBtn.disabled = tabData.historyIndex >= tabData.history.length - 1;
            }


            // --- Shortcuts Management ---
            let shortcuts = [];

            function renderShortcuts() {
                shortcutsGrid.innerHTML = '';
                shortcuts.forEach(sc => {
                    const shortcutEl = document.createElement('a');
                    shortcutEl.className = 'shortcut-item';

                    // No UV encoding needed for display or for the href if we handle navigation via JS
                    // The navigate function will handle proxying.
                    shortcutEl.href = "#"; // Prevent default nav, handle with JS
                    shortcutEl.dataset.url = sc.url; // Store original URL

                    const iconSrc = sc.iconUrl || `https://www.google.com/s2/favicons?domain=${new URL(sc.url.startsWith('http') || sc.url.startsWith('https') ? sc.url : 'https://' + sc.url).hostname}&sz=64`;

                    shortcutEl.innerHTML = `
                        <div class="shortcut-icon"><img src="${iconSrc}" alt="${sc.name.substring(0,2)}" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-link\\'></i>';"></div>
                        <div class="shortcut-title">${sc.name}</div>
                        <div class="shortcut-url">${new URL(sc.url.startsWith('http') || sc.url.startsWith('https') ? sc.url : 'https://' + sc.url).hostname}</div>
                    `;
                    shortcutEl.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigate(sc.url);
                    });
                    shortcutsGrid.appendChild(shortcutEl);
                });

                // Re-create and append the "Add Shortcut" button if it's defined
                if (addShortcutBtn) {
                    shortcutsGrid.appendChild(addShortcutBtn);
                }
            }


            function loadShortcuts() {
                const storedShortcuts = localStorage.getItem('vernProShortcuts');
                try {
                    shortcuts = storedShortcuts ? JSON.parse(storedShortcuts) : [
                        { name: 'Google', url: 'https://google.com', iconUrl: null },
                        { name: 'GitHub', url: 'https://github.com', iconUrl: null }
                    ];
                } catch (e) {
                     shortcuts = [
                        { name: 'Google', url: 'https://google.com', iconUrl: null },
                        { name: 'GitHub', url: 'https://github.com', iconUrl: null }
                    ];
                     console.error("Error parsing shortcuts from localStorage", e);
                }
                renderShortcuts();
            }

            function saveShortcuts() {
                localStorage.setItem('vernProShortcuts', JSON.stringify(shortcuts));
            }

            // Ensure addShortcutBtn exists before adding event listener
            if (addShortcutBtn) {
                 addShortcutBtn.addEventListener('click', () => {
                    shortcutNameInput.value = '';
                    shortcutUrlInput.value = ''; // Ensure this ID matches your input field for URL
                    shortcutIconUrlInput.value = '';
                    addShortcutModal.classList.add('active');
                });
            }


            saveShortcutBtn.addEventListener('click', () => {
                const name = shortcutNameInput.value.trim();
                const url = shortcutUrlInput.value.trim(); // Ensure this ID matches
                const iconUrl = shortcutIconUrlInput.value.trim();

                if (name && url) {
                    // Basic URL validation (starts with http or https)
                    let finalUrl = url;
                    if (!url.match(/^https?:\/\//i) && !url.startsWith('about:') && !url.startsWith('file:')) {
                        finalUrl = 'https://' + url;
                    }
                    shortcuts.push({ name, url: finalUrl, iconUrl: iconUrl || null });
                    saveShortcuts();
                    renderShortcuts();
                    addShortcutModal.classList.remove('active');
                } else {
                    alert('Please provide a name and URL for the shortcut.');
                }
            });


            // --- Modal Handling ---
            document.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal').classList.remove('active');
                });
            });
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => modal.classList.remove('active'));
                }
            });
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });


            // --- Settings Modal & Theming ---
            function openSettingsModal() {
                settingsModal.classList.add('active');
            }
            document.querySelectorAll('[data-action="open-settings-modal"]').forEach(btn => {
                btn.addEventListener('click', openSettingsModal);
            });


            const themeOptions = document.querySelectorAll('.theme-option');
            themeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const theme = option.dataset.theme;
                    applyTheme(theme);
                    localStorage.setItem('vernProTheme', theme);
                    themeOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                });
            });

            function applyTheme(theme) {
                const root = document.documentElement;
                // Remove any previously applied theme classes
                root.classList.remove('theme-light', 'theme-purple', 'theme-blue', 'theme-green', 'theme-orange');
                // Add the new theme class (dark is default, no class needed)
                if (theme !== 'dark') {
                     root.classList.add(`theme-${theme}`);
                }

                // Store and apply theme variables from CSS (already handled by CSS variables)
                // The JS only needs to toggle classes and potentially adjust variables if needed (less flexible than CSS vars)
                 if (theme === 'light') {
                    // Overrides for light theme variables if not fully handled by CSS
                    root.style.setProperty('--bg-color', '#f0f0f0');
                    root.style.setProperty('--text-color', '#333');
                    root.style.setProperty('--navbar-bg', 'rgba(230, 230, 230, 1)');
                    root.style.setProperty('--button-bg', 'rgba(220, 220, 220, 0.8)');
                    root.style.setProperty('--search-bg', 'rgba(220, 220, 220, 0.8)');
                    root.style.setProperty('--iframe-bg', '#fff');
                    root.style.setProperty('--tab-bg', 'rgba(210, 210, 210, 0.8)');
                    root.style.setProperty('--tab-active-bg', 'rgba(200, 200, 200, 0.9)');
                    root.style.setProperty('--footer-text-color', '#555');
                    root.style.setProperty('--sidebar-bg', 'rgba(225, 225, 225, 0.95)');
                    root.style.setProperty('--shortcut-bg', 'rgba(235, 235, 235, 0.9)');
                    root.style.setProperty('--modal-bg', 'rgba(240, 240, 240, 0.98)');
                    root.style.setProperty('--input-bg', 'rgba(220, 220, 220, 0.95)');
                } else {
                    // Reset variables for non-light themes if they were changed
                     // This is less ideal than letting CSS variables handle it
                    const initialStyles = document.getElementById('custom-styles').sheet.cssRules[0].style;
                     for (let i = 0; i < initialStyles.length; i++) {
                        const propName = initialStyles[i];
                        if (propName.startsWith('--')) {
                            root.style.setProperty(propName, initialStyles.getPropertyValue(propName));
                        }
                    }
                     // Apply accent colors if needed, though CSS variables should handle this
                     if (theme === 'purple') {
                         root.style.setProperty('--accent-color', '#9b59b6');
                         root.style.setProperty('--accent-hover', '#8e44ad');
                     } else if (theme === 'blue') {
                         root.style.setProperty('--accent-color', '#3498db');
                         root.style.setProperty('--accent-hover', '#2980b9');
                     } else if (theme === 'green') {
                         root.style.setProperty('--accent-color', '#2ecc71');
                         root.style.setProperty('--accent-hover', '#27ae60');
                     } else if (theme === 'orange') {
                         root.style.setProperty('--accent-color', '#e67e22');
                         root.style.setProperty('--accent-hover', '#d35400');
                     }
                }
                 resizeCanvas(); // Ensure canvas redraws for new theme colors if applicable
            }

            const settingShowProBar = document.getElementById('setting-show-pro-bar');
            settingShowProBar.addEventListener('change', function() {
                const proBar = document.getElementById('pro-options-bar');
                proBar.style.display = this.checked ? 'flex' : 'none';
                updateTopBarAssemblyHeight();
                updateToggleTopBarButtonPosition(); // Adjust top bar toggle position
                localStorage.setItem('vernProShowProBar', this.checked);
                resizeCanvas(); // Resize canvas if pro bar visibility changes
            });

            const startupBehaviorSelect = document.getElementById('setting-startup-behavior');
            const homepageUrlGroup = document.getElementById('setting-homepage-url-group');
            const homepageUrlInput = document.getElementById('setting-homepage-url');

            startupBehaviorSelect.addEventListener('change', function() {
                homepageUrlGroup.style.display = (this.value === 'homepage') ? 'block' : 'none';
                localStorage.setItem('vernProStartupBehavior', this.value);
            });
            homepageUrlInput.addEventListener('input', function() { // Use input for immediate save
                 localStorage.setItem('vernProHomepageUrl', this.value);
            });

            document.getElementById('clear-browse-data-btn')?.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all browser data (localStorage, cookies, etc.)? This cannot be undone.')) {
                     // Clear localStorage
                    localStorage.clear();
                     // Clear cookies (basic attempt)
                     document.cookie.split(";").forEach(function(c) { document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); });
                     // For a full implementation, you'd also need to clear IndexedDB, Cache API, Service Worker caches, etc.
                     alert('Browser data cleared (primarily localStorage and cookies). Please reload the page for a full reset.');
                     // Optionally reload
                    // window.location.reload();
                }
            });


            function loadSettings() {
                const savedTheme = localStorage.getItem('vernProTheme') || 'dark';
                applyTheme(savedTheme);
                document.querySelectorAll('.theme-option').forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.theme === savedTheme);
                });

                const showProBar = localStorage.getItem('vernProShowProBar') !== 'false';
                settingShowProBar.checked = showProBar;
                document.getElementById('pro-options-bar').style.display = showProBar ? 'flex' : 'none';

                const startupBehavior = localStorage.getItem('vernProStartupBehavior') || 'newtab';
                startupBehaviorSelect.value = startupBehavior;
                homepageUrlGroup.style.display = (startupBehavior === 'homepage') ? 'block' : 'none';
                homepageUrlInput.value = localStorage.getItem('vernProHomepageUrl') || 'https://google.com';

                const doNotTrack = localStorage.getItem('vernProDoNotTrack') === 'true';
                document.getElementById('setting-do-not-track').checked = doNotTrack;
                // Actual DNT header sending would need server-side or extension capabilities

                const fontSize = localStorage.getItem('vernProFontSize') || '14px';
                document.getElementById('setting-font-size').value = fontSize;
                document.documentElement.style.fontSize = fontSize; // Apply global font size
                 document.getElementById('setting-font-size').addEventListener('change', function() {
                    document.documentElement.style.fontSize = this.value;
                    localStorage.setItem('vernProFontSize', this.value);
                 });


                loadShortcuts();
            }

            document.getElementById('setting-do-not-track').addEventListener('change', function() {
                localStorage.setItem('vernProDoNotTrack', this.checked);
                alert("Do Not Track preference saved. Note: Actual DNT header behavior depends on browser/proxy capabilities not directly controlled here.");
            });


            // --- Dropdown Menus ---
            document.querySelectorAll('[data-dropdown-target]').forEach(toggle => {
                toggle.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const menuId = toggle.dataset.dropdownTarget;
                    const menu = document.getElementById(menuId);
                    if (!menu) return;

                    document.querySelectorAll('.dropdown-menu.show').forEach(openMenu => {
                        if (openMenu !== menu) {
                            openMenu.classList.remove('show');
                        }
                    });
                    menu.classList.toggle('show');
                });
            });

            window.addEventListener('click', (event) => {
                if (!event.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });

            // --- Sidebar Actions & Other Button Actions ---
            function handleSidebarAction(action) {
                console.log("Sidebar action:", action);
                const currentTab = tabs.find(t => t.id === activeTabId);
                switch(action) {
                    case 'show-home':
                        const existingHomeTab = tabs.find(t => t.url === 'shortcuts' || t.actualUrl === 'shortcuts');
                        if (existingHomeTab) {
                            switchToTab(existingHomeTab.id);
                        } else {
                            createNewTab('shortcuts');
                        }
                        break;
                    case 'show-bookmarks':
                    case 'manage-bookmarks': // from user dropdown
                        alert('Bookmarks manager not yet implemented.');
                        break;
                    case 'show-history':
                    case 'open-history': // from user dropdown
                        alert('History viewer not yet implemented.');
                        break;
                    case 'show-downloads':
                        alert('Downloads page not yet implemented.');
                        break;
                    case 'open-devtools':
                        alert('Developer Tools not yet implemented in this web version.');
                        break;
                    case 'open-extensions':
                        alert('Extensions page not yet implemented.');
                        break;
                    case 'show-profile': // Sidebar footer profile
                        document.getElementById('user-profile-btn')?.click(); // Open nav bar profile dropdown
                        break;
                    case 'sign-out': // from user dropdown
                        alert('Sign Out not implemented.');
                        break;
                     case 'manage-shortcuts': // from shortcuts page button
                         alert('Managing shortcuts (edit/delete) not yet implemented.');
                         break;
                    default:
                        // For any other data-action clicks not explicitly handled elsewhere
                         if (document.querySelector(`[data-action="${action}"]`)) {
                            alert(`Action: ${action} (not implemented)`);
                        }
                        break;
                }
            }
            // Attach generic action handler for elements with data-action not covered by specific listeners
            document.body.addEventListener('click', function(event) {
                const target = event.target.closest('[data-action]');
                if (target && target.dataset.action) {
                    // Check if it's one of the already handled types by other more specific listeners
                    const specificActions = ['open-settings-modal', 'show-home', 'show-bookmarks', 'show-history', 'show-downloads', 'open-devtools', 'open-extensions', 'show-profile', 'toggle-user-menu', 'manage-shortcuts'];
                    const isHandledElsewhere = specificActions.includes(target.dataset.action);
                    const isDropdownToggle = target.hasAttribute('data-dropdown-target');

                    if (!isHandledElsewhere && !isDropdownToggle && !target.closest('.modal')) { // Avoid re-triggering for modals or specific items
                        // Check if it's a pro-menu-item or dropdown-item from pro bar
                        if (target.classList.contains('pro-menu-item') || target.classList.contains('dropdown-item')) {
                             // Already handled by placeholder in initializeBrowser
                        } else {
                             // Handle any other data-action
                             handleSidebarAction(target.dataset.action);
                        }
                    }
                }
            });



            // --- Canvas Background (Simple Example) ---
             function drawBackground() {
                 if (!canvas || !ctx) return;
                 // Example: A simple gradient or pattern
                 const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                 gradient.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--bg-color').trim() || '#1a1a1a');
                 gradient.addColorStop(1, 'rgba(30, 30, 30, 1)');
                 ctx.fillStyle = gradient;
                 ctx.fillRect(0, 0, canvas.width, canvas.height);

                  // Optional: Add some simple animated elements if desired
                  // This requires a separate animation loop
             }
             // Redraw background when canvas is resized or theme changes
             window.addEventListener('resize', drawBackground);


            // --- Keyboard Shortcuts ---
            document.addEventListener('keydown', (e) => {
                // Allow typing in form fields
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    // Allow F5 and Alt+Arrow keys even in inputs
                    if (e.key === 'F5' || (e.altKey && (e.key === 'ArrowLeft' || e.key === 'ArrowRight'))) {
                         e.preventDefault();
                         if (e.key === 'F5') reloadBtn.click();
                         if (e.altKey && e.key === 'ArrowLeft') backBtn.click();
                         if (e.altKey && e.key === 'ArrowRight') forwardBtn.click();
                    }
                     return;
                }

                if (e.ctrlKey || e.metaKey) { // Ctrl or Command key
                    switch (e.key.toLowerCase()) {
                        case 't':
                            e.preventDefault();
                            createNewTab(DEFAULT_HOME_PAGE, true); // Make new tab active
                            break;
                        case 'w':
                            e.preventDefault();
                            if (activeTabId) closeTab(activeTabId);
                            break;
                        case 'tab':
                            e.preventDefault();
                            if (tabs.length > 1) {
                                const currentIndex = tabs.findIndex(t => t.id === activeTabId);
                                const nextIndex = (e.shiftKey ? (currentIndex - 1 + tabs.length) : (currentIndex + 1)) % tabs.length;
                                switchToTab(tabs[nextIndex].id);
                            }
                            break;
                        case 'r': // Ctrl+R for reload
                             e.preventDefault();
                             reloadBtn.click();
                             break;
                        case 'l': // Ctrl+L to focus search bar
                            e.preventDefault();
                            searchBar.focus();
                            searchBar.select(); // Select all text
                            break;
                        case 'h': // Ctrl+H for history (placeholder)
                            e.preventDefault();
                            handleSidebarAction('show-history');
                             break;
                         case 'j': // Ctrl+J for downloads (placeholder)
                            e.preventDefault();
                            handleSidebarAction('show-downloads');
                            break;
                        case 'b': // Ctrl+B for bookmarks (placeholder)
                            e.preventDefault();
                            handleSidebarAction('show-bookmarks');
                            break;
                        case 'comma': // Ctrl+, for settings
                            e.preventDefault();
                            openSettingsModal();
                            break;
                    }
                } else if (e.altKey) {
                     switch (e.key.toLowerCase()) {
                        case 'arrowleft':
                            e.preventDefault();
                            backBtn.click();
                            break;
                        case 'arrowright':
                            e.preventDefault();
                            forwardBtn.click();
                            break;
                    }
                } else {
                     switch (e.key) { // Use raw key for function keys
                        case 'F5': // F5 for reload
                            e.preventDefault();
                            reloadBtn.click();
                            break;
                    }
                }
            });

            // Initialize
            initializeBrowser();
            drawBackground(); // Initial drawing of the background

            // Optional: Implement a simple animation loop for the canvas if needed
            // function animateCanvas() {
            //     // Drawing logic here
            //     requestAnimationFrame(animateCanvas);
            // }
            // animateCanvas(); // Start animation loop
        });
    </script>
</body>
</html>
